<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Viking Pong Fotball ‚Äì Mobil</title>
    <style>
/* ======= MOBIL-OPTIMALISERT CSS ======= */
* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #0a1420, #1a2d42);
    font-family: 'Arial', sans-serif;
    color: white;
    overflow: hidden;
    touch-action: none;
    position: fixed;
    width: 100%;
    height: 100%;
    -webkit-user-select: none;
    user-select: none;
}

#gameContainer {
    width: 100vw;
    height: 100vh;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
}

/* ======= UI OG SCOREBOARD ======= */
#ui {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    z-index: 100;
    width: 100%;
    display: flex;
    justify-content: center;
    pointer-events: none;
}

.scoreboard-container {
    display: flex;
    align-items: center;
    gap: 15px;
    height: 90px;
}

.field-logo {
    width: 75px;
    height: 75px;
    padding: 3px;
    background: transparent;
    object-fit: contain;
}

.scoreboard {
    background: linear-gradient(135deg, #1a1a1a, #2a2a2a, #1a1a1a);
    border: 2px solid #444444;
    border-radius: 6px;
    padding: 6px 12px;
    box-shadow: 
        0 0 40px rgba(0,0,0,0.9),
        inset 0 0 30px rgba(255,215,0,0.05);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    min-width: 280px;
    height: 80px;
    position: relative;
}

.score-line {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    justify-content: space-between;
}

.team-name-led {
    color: #FFD700;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 12px;
    text-shadow: 0 0 8px #FFD700;
    min-width: 100px;
    max-width: 100px;
    text-align: left;
}

.score-led {
    color: #FFD700;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 16px;
    text-shadow: 0 0 10px #FFD700;
    background: #000;
    padding: 3px 6px;
    border-radius: 4px;
    border: 2px solid #333;
    min-width: 50px;
    text-align: center;
    margin-right: 25px;
}

.clock-led {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    color: #FFD700;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 12px;
    text-shadow: 0 0 10px #FFD700;
    background: #000;
    padding: 4px 6px;
    border-radius: 6px;
    border: 2px solid #333;
}

/* ======= SPILLBRETT ======= */
#gameField {
    width: 95vw;
    margin-top: 100px;
    height: calc(100vh - 180px);
    background: linear-gradient(90deg, #2d5016, #387020, #4a8a2a, #387020, #2d5016);
    border: 6px solid #ffffff;
    position: relative;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 40px rgba(0,255,0,0.4);
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
}

.field-pattern {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: repeating-linear-gradient(
        90deg,
        transparent 0px,
        transparent 29px,
        rgba(255,255,255,0.1) 30px,
        rgba(255,255,255,0.1) 31px
    );
}

.center-line {
    position: absolute;
    left: 5%;
    top: 50%;
    width: 90%;
    height: 4px;
    background: white;
    transform: translateY(-50%);
}

.center-circle {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 120px;
    height: 120px;
    border: 4px solid white;
    border-radius: 50%;
    transform: translate(-50%, -50%);
}

/* M√•l-linjer */
#gameField::before {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 30%;
    right: 30%;
    height: 3px;
    background: white;
    border-radius: 2px;
    box-shadow: 0 0 10px rgba(255,255,255,0.5);
}

#gameField::after {
    content: '';
    position: absolute;
    top: -3px;
    left: 30%;
    right: 30%;
    height: 3px;
    background: white;
    border-radius: 2px;
    box-shadow: 0 0 10px rgba(255,255,255,0.5);
}

/* ======= SPILLERE OG BALL ======= */
.player {
    position: absolute;
    width: 80px;
    height: 15px;
    border-radius: 7px;
    border: 3px solid white;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
}

.viking {
    left: 50%;
    bottom: 20px;
    transform: translateX(-50%);
    background: linear-gradient(180deg, #002166, #003399, #002166);
    box-shadow: 0 0 25px rgba(0, 33, 102, 0.8);
}

.opponent {
    left: 50%;
    top: 20px;
    transform: translateX(-50%);
}

.ball {
    position: absolute;
    width: 15px;
    height: 15px;
    background: radial-gradient(circle at 35% 35%, #ffffff, #e8e8e8, #d0d0d0);
    border: 2px solid #333;
    border-radius: 50%;
    box-shadow: 0 0 20px rgba(255,255,255,0.9);
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    will-change: transform;
}

/* ======= KONTROLLOMR√ÖDE ======= */
.touch-area {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    height: 60px;
    background: linear-gradient(135deg, #002166, #003399);
    color: #FFFFFF;
    text-align: center;
    font-size: 12px;
    z-index: 100;
    border-top: 2px solid #002166;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

/* ======= INTRO SCREEN ======= */
#introScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #0a1420, #1a2d42);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

#introScreen img {
    max-width: 250px;
    max-height: 150px;
    object-fit: contain;
    margin-bottom: 20px;
    border-radius: 15px;
    box-shadow: 0 0 40px rgba(255,215,0,0.3);
}

.intro-title {
    color: #FFD700;
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 15px;
    font-family: 'Courier New', monospace;
    text-shadow: 0 0 10px #FFD700;
    text-align: center;
}

#loadingProgress {
    width: 200px;
    height: 15px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 15px;
}

#progressBar {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #FFD700, #00FF00);
    transition: width 0.3s ease;
}

#startGameBtn {
    background: linear-gradient(135deg, #00AA00, #00FF00);
    color: #000;
    border: none;
    padding: 12px 25px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0,170,0,0.3);
    display: none;
}

/* ======= KNAPPER ======= */
.button {
    background: linear-gradient(135deg, #8B0000, #CD5C5C);
    color: white;
    border: none;
    padding: 12px 24px;
    margin: 10px 6px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(139,0,0,0.3);
    pointer-events: auto;
}

/* ======= POPUPS ======= */
.goal-scorer-display {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #000000, #1a1a1a);
    padding: 18px 25px;
    border-radius: 20px;
    text-align: center;
    z-index: 500;
    border: 2px solid #FFD700;
    box-shadow: 0 0 40px rgba(255,215,0,0.5);
    max-width: 260px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.goal-scorer-display.viking {
    border: 2px solid #002166;
    box-shadow: 0 0 40px rgba(0,33,102,0.5);
}

.goal-scorer-display img,
.goal-scorer-display > div:first-child {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 4px solid #FFD700;
    margin-bottom: 8px;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #FFD700;
}

.goal-scorer-display.viking img,
.goal-scorer-display.viking > div:first-child {
    border: 4px solid #4A90E2;
    box-shadow: 0 0 20px rgba(74, 144, 226, 0.8);
    background: linear-gradient(135deg, #4A90E2, #002166);
}

.goal-scorer-name {
    color: #FFD700;
    font-size: 15px;
    font-weight: bold;
    margin-bottom: 6px;
    font-family: 'Courier New', monospace;
    text-shadow: 0 0 10px #FFD700;
}

.goal-scorer-display.viking .goal-scorer-name {
    color: #87CEEB;
    text-shadow: 0 0 8px #87CEEB;
}

.goal-scorer-team {
    color: #00FF00;
    font-size: 13px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
}

.halftime-screen,
.var-screen,
#gameMessage {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.95);
    padding: 18px 25px;
    border-radius: 20px;
    text-align: center;
    z-index: 400;
    border: 4px solid #FFD700;
    max-width: 280px;
    box-shadow: 0 0 50px rgba(255,215,0,0.5);
    display: none;  /* <- LEGG TIL DENNE LINJEN */
}

.var-screen {
    border: 4px solid #FF0000;
    box-shadow: 0 0 50px rgba(255,0,0,0.5);
}
.var-lines {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 550;
}

.offside-line {
    position: absolute;
    width: 4px;
    height: 60%;
    top: 20%;
    opacity: 0;
    box-shadow: 0 0 10px currentColor;
    transition: all 0.5s ease-in-out;
}

.offside-line.red {
    background: #FF0000;
    color: #FF0000;
}

.offside-line.green {
    background: #00FF00;
    color: #00FF00;
}

.var-checking {
    animation: varPulse 1s ease-in-out infinite;
}

@keyframes varLineAppear {
    0% { 
        opacity: 0; 
        transform: scaleY(0) rotate(0deg); 
    }
    100% { 
        opacity: 1; 
        transform: scaleY(1) rotate(var(--rotation)); 
    }
}

@keyframes varPulse {
    0%, 100% { color: #FF0000; }
    50% { color: #FFFF00; }
}
/* ======= ANIMASJONER ======= */
@keyframes crowdPulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.7; }
}

@keyframes vikingGlow {
    0% { 
        box-shadow: 
            0 0 20px rgba(74, 144, 226, 0.8),
            0 0 40px rgba(74, 144, 226, 0.6);
    }
    100% { 
        box-shadow: 
            0 0 30px rgba(74, 144, 226, 1),
            0 0 50px rgba(74, 144, 226, 0.8);
    }
}

/* ======= RUNDEOVERSIKT ======= */
#roundSummary {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.96);
    padding: 25px 15px 100px 15px;
    text-align: center;
    font-size: 12px;
    z-index: 200;
    display: none;
    overflow-y: auto;
}

/* Navigasjonsknapper for rundeoversikt */
.summary-nav-btn,
.summary-main-btn {
    position: fixed !important;
    bottom: 80px !important;
    font-size: 14px !important;
    padding: 12px 20px !important;
    border-radius: 25px !important;
    z-index: 250 !important;
    color: white !important;
    font-weight: bold !important;
    cursor: pointer !important;
    max-width: 35vw !important;
    text-align: center !important;
}

.result-row {
    font-size: 11px;
    padding: 4px 0;
    margin: 0 8px;
}
    </style>
</head>
<body>
    <!-- INTRO SKJERM -->
    <div id="introScreen">
        <img src="assets/images/stavangers-finaste.png" alt="Stavangers Finaste" onerror="this.style.display='none';">
        
        <div class="intro-title" id="loadingTitle">
            üîä LASTER SPILLDATA...
        </div>
        
        <div id="loadingProgress">
            <div id="progressBar"></div>
        </div>
        
        <div class="intro-text">
            Forbereder Viking FK Eliteserien 2025<br>
            Laster supporter-lyd og kampdata...
        </div>
        
        <button id="startGameBtn" onclick="startMainGame()">
            üéÆ START SPILLET!
        </button>
    </div>

    <div id="gameContainer">
        <div id="ui">
            <div class="scoreboard-container">
                <img id="leftLogo" src="assets/teams/viking-fk.png" class="field-logo left-logo">
                
                <div class="scoreboard">
                    <div class="score-line">
                        <div class="team-name-led" id="homeTeamName">VIKING FK</div>
                        <div class="score-led" id="homeScore">0</div>
                    </div>
                    <div class="score-line">
                        <div class="team-name-led" id="awayTeamName">MOTSTANDER</div>
                        <div class="score-led" id="awayScore">0</div>
                    </div>
                    
                    <div class="clock-led" id="matchClock">0'</div>
                </div>
                
                <img id="rightLogo" src="assets/teams/unknown.png" class="field-logo right-logo">
            </div>
        </div>

        <div id="roundSummary">
            <div id="roundSummaryContent"></div>
        </div>

        <div id="gameField">
            <div class="crowd-noise" style="animation: crowdPulse 3s ease-in-out infinite;"></div>
            <div class="field-pattern"></div>
            <div class="center-line"></div>
            <div class="center-circle"></div>
            <div class="center-spot" style="position: absolute; left: 50%; top: 50%; width: 8px; height: 8px; background: white; border-radius: 50%; transform: translate(-50%, -50%);"></div>

            <div class="player viking" id="viking"></div>
            <div class="player opponent" id="opponent"></div>
            <div class="ball" id="ball"></div>
        </div>

        <div class="touch-area" id="touchArea">
            ‚Üê styr spiller ‚Üí
        </div>

        <div id="gameMessage">
            <div id="messageText"></div>
            <button class="button" onclick="restartSeason()">Ny sesong</button>
        </div>
    </div>

    <script>
// ===== GLOBALE VARIABLER =====
let loadingProgress = 0;
let introStarted = false;
let cupTopScorers = [];
let lastFrameTime = Date.now();

// Spilletilstand - KUN MOBIL
let gameState = {
    vikingScore: 0,
    opponentScore: 0,
    ballX: 300,
    ballY: 350,
    ballVelX: 0,
    ballVelY: 0,
    vikingX: 300,
    opponentX: 300,
    gameActive: true,
    currentRound: 1,
    roundResults: [],
    paused: false,
    topScorers: [],
    currentOpponentTeam: null,
    currentHalf: 1,
    matchTime: 0,
    matchDuration: 60000,
    matchStartTime: null,
    halfTimeBreak: false,
    summaryPage: 1,
    currentMatchIndex: 0,
    cupEliminated: false,
    lastCollisionTime: 0
};

// ===== FORBEDRET LYDOPPSETT =====
const soundSystem = {
    audioContext: null,
    supporterAudio: null,
    introAudio: null,
    ballHitAudio: null,
    whistleAudio: null,
    goalCelebrationAudio: null,
    anthemAudio: null,
    isEnabled: true,

    config: {
        masterVolume: 0.7,
        supporterVolume: 0.4,
        introVolume: 0.6,
        effectVolume: 0.6,
        anthemVolume: 0.8,
        fileDuration: 53 * 60,
        minStartTime: 120,
        maxStartTime: 45 * 60,
        retryAttempts: 3,
        retryDelay: 2000
    },
    
    init() {
        try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.log('Web Audio API ikke st√∏ttet');
        }
        this.loadSounds();
        this.setupSupporterAudioEvents();
        this.setupIntroAudio();
    },
    
    loadSounds() {
        // Intro-lyd
        this.introAudio = new Audio('assets/sounds/viking_intro.mp3');
        this.introAudio.volume = this.config.introVolume * this.config.masterVolume;
        this.introAudio.preload = 'auto';
        this.introAudio.loop = true;
        this.introAudio.onerror = () => console.log('Intro-lyd ikke funnet, fortsetter uten');
        
        // Viking supporter-lyd
        this.supporterAudio = new Audio('assets/sounds/viking_supporters.mp3');
        this.supporterAudio.volume = this.config.supporterVolume * this.config.masterVolume;
        this.supporterAudio.preload = 'auto';
        this.supporterAudio.loop = false;
        this.supporterAudio.onerror = () => console.log('Supporter-lyd ikke funnet, fortsetter uten');
        
        // Ball-hit lyd
        this.ballHitAudio = new Audio('assets/sounds/ball_hit.mp3');
        this.ballHitAudio.volume = this.config.effectVolume * this.config.masterVolume;
        this.ballHitAudio.preload = 'auto';
        this.ballHitAudio.onerror = () => console.log('Ball-hit lyd ikke funnet, fortsetter uten');
        
        // Dommerfl√∏yte
        this.whistleAudio = new Audio('assets/sounds/whistle.mp3');
        this.whistleAudio.volume = this.config.effectVolume * this.config.masterVolume;
        this.whistleAudio.preload = 'auto';
        this.whistleAudio.onerror = () => console.log('Whistle-lyd ikke funnet, fortsetter uten');
        
        // M√•l
        this.scoringAudio = new Audio('assets/sounds/scoring.mp3');
        this.scoringAudio.volume = this.config.effectVolume * this.config.masterVolume;
        this.scoringAudio.preload = 'auto';
        this.scoringAudio.onerror = () => console.log('Scoring-lyd ikke funnet');

        // VAR
        this.varAudio = new Audio('assets/sounds/var.mp3');
        this.varAudio.volume = this.config.effectVolume * this.config.masterVolume;
        this.varAudio.preload = 'auto';
        this.varAudio.onerror = () => console.log('VAR-lyd ikke funnet');

        // Viking feiring
        this.goalCelebrationAudio = new Audio('assets/sounds/viking_celebration.mp3');
        this.goalCelebrationAudio.volume = this.config.effectVolume * this.config.masterVolume;
        this.goalCelebrationAudio.preload = 'auto';
        this.goalCelebrationAudio.onerror = () => {
            console.log('‚ö†Ô∏è viking_celebration.mp3 ikke funnet, bruker scoring-lyd i stedet');
            this.goalCelebrationAudio = null;
        };

        // Victory lyd
        this.victoryAudio = new Audio('assets/sounds/anthem.mp3');
        this.victoryAudio.volume = this.config.anthemVolume * this.config.masterVolume;
        this.victoryAudio.preload = 'auto';
        this.victoryAudio.loop = false;
        this.victoryAudio.onerror = () => console.log('Victory-lyd ikke funnet, fortsetter uten');
        
        this.createSimpleWhistle();
    },

    stopAllGoalSounds() {
        if (this.scoringAudio) {
            this.scoringAudio.pause();
            this.scoringAudio.currentTime = 0;
        }
        if (this.goalCelebrationAudio) {
            this.goalCelebrationAudio.pause();
            this.goalCelebrationAudio.currentTime = 0;
        }
    },
    
    createSimpleWhistle() {
        this.whistle = {
            play: () => {
                if (!this.audioContext) return;
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(1000, this.audioContext.currentTime);
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(this.config.effectVolume, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.3);
                } catch (e) {
                    console.log('Kunne ikke spille fl√∏yte-lyd');
                }
            }
        };
    },
    
    setupIntroAudio() {
        if (!this.introAudio) return;
        
        this.introAudio.addEventListener('canplaythrough', () => {
            console.log('üéµ Intro-lyd klar til avspilling');
        });
        
        this.introAudio.addEventListener('error', (e) => {
            console.log('üéµ Intro-lyd feil:', e);
        });
    },

    setupSupporterAudioEvents() {
        if (!this.supporterAudio) return;
        
        this.supporterAudio.addEventListener('ended', () => {
            console.log('üéµ Supporter-lyd ferdig, restarter...');
            if (gameState.gameActive && !gameState.paused) {
                setTimeout(() => this.restartSupporters(), 1000);
            }
        });
        
        this.supporterAudio.addEventListener('pause', () => {
            console.log('üéµ Supporter-lyd pauset');
        });
        
        this.supporterAudio.addEventListener('error', (e) => {
            console.log('üéµ Supporter-lyd feil, pr√∏ver restart:', e);
            this.restartSupportersWithRetry();
        });
        
        this.supporterAudio.addEventListener('canplaythrough', () => {
            console.log('üéµ Supporter-lyd klar til avspilling');
        });
    },
    
    startIntro() {
        if (!this.introAudio) return;
        
        try {
            this.introAudio.currentTime = 0;
            const playPromise = this.introAudio.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log('üéµ Intro-lyd startet');
                    })
                    .catch(e => {
                        console.log('Kunne ikke starte intro-lyd:', e);
                    });
            }
        } catch (e) {
            console.log('Feil ved start av intro-lyd:', e);
        }
    },
    
    stopIntro() {
        if (this.introAudio) {
            this.introAudio.pause();
            this.introAudio.currentTime = 0;
        }
    },
    
    startSupporters() {
        this.stopIntro();

        if (!this.supporterAudio) return;
        
        try {
            this.supporterAudio.pause();
            this.supporterAudio.currentTime = 0;
            
            const playPromise = this.supporterAudio.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log('üéµ Supporter-lyd startet umiddelbart');
                        setTimeout(() => {
                            if (!this.supporterAudio.paused) {
                                const randomTime = this.config.minStartTime + 
                                    Math.random() * (this.config.maxStartTime - this.config.minStartTime);
                                this.supporterAudio.currentTime = randomTime;
                                console.log(`üéµ Hoppet til ${Math.floor(randomTime/60)}:${Math.floor(randomTime%60).toString().padStart(2, '0')}`);
                            }
                        }, 2000);
                    })
                    .catch(e => {
                        console.log('Kunne ikke starte supporter-lyd umiddelbart, pr√∏ver senere');
                        setTimeout(() => this.retryStartSupporters(), 1000);
                    });
            }
            
        } catch (e) {
            console.log('Feil ved start av supporter-lyd:', e);
            this.retryStartSupporters();
        }
    },

    retryStartSupporters() {
        if (!this.supporterAudio) return;
        
        try {
            const randomStart = this.config.minStartTime + 
                Math.random() * (this.config.maxStartTime - this.config.minStartTime);
            
            this.supporterAudio.currentTime = randomStart;
            this.supporterAudio.play().catch(e => {
                console.log('Retry feiler ogs√•, bruker backup-lyd');
            });
            
        } catch (e) {
            console.log('Retry-fors√∏k feilet:', e);
        }
    },

    restartSupportersWithRetry(attempt = 1) {
        if (attempt > this.config.retryAttempts) {
            console.log('üéµ Gir opp restart av supporter-lyd etter', this.config.retryAttempts, 'fors√∏k');
            return;
        }
        
        console.log(`üéµ Pr√∏ver restart av supporter-lyd (fors√∏k ${attempt})`);
        
        setTimeout(() => {
            if (gameState.gameActive && !gameState.paused) {
                this.startSupporters();
                
                setTimeout(() => {
                    if (this.supporterAudio && this.supporterAudio.paused) {
                        this.restartSupportersWithRetry(attempt + 1);
                    }
                }, 2000);
            }
        }, this.config.retryDelay);
    },

    restartSupporters() {
        if (gameState.gameActive && !gameState.paused) {
            this.startSupporters();
        }
    },
    
    stopSupporters() {
        if (this.supporterAudio) {
            this.supporterAudio.pause();
        }
    },

    playWhistle() {
        if (this.whistleAudio) {
            this.whistleAudio.currentTime = 0;
            this.whistleAudio.play().catch(e => {
                console.log('Whistle-fil ikke tilgjengelig, bruker backup');
                if (this.whistle) this.whistle.play();
            });
        } else if (this.whistle) {
            this.whistle.play();
        }
    },

    playBallHit() {
        if (this.ballHitAudio) {
            this.ballHitAudio.currentTime = 0;
            this.ballHitAudio.play().catch(e => console.log('Ball-hit lyd ikke tilgjengelig'));
        }
    },

    playScoring() {
        if (this.scoringAudio) {
            this.scoringAudio.currentTime = 0;
            this.scoringAudio.play().catch(e => console.log('Scoring-lyd feilet'));
        }
    },

    playAnthem() {
        if (this.victoryAudio && this.isEnabled) {
            this.victoryAudio.currentTime = 0;
            this.victoryAudio.play().catch(e => console.log('Victory sound play failed:', e));
        }
    },

    stopAnthem() {
        if (this.victoryAudio) {
            this.victoryAudio.pause();
            this.victoryAudio.currentTime = 0;
        }
    },

    playVAR() {
        if (this.varAudio) {
            this.varAudio.currentTime = 0;
            this.varAudio.play().catch(e => console.log('VAR-lyd feilet'));
        }
    },

    playViking5Goals() {
        console.log('üéâ Pr√∏ver √• spille Viking 5-m√•l celebration...');
        if (this.goalCelebrationAudio) {
            this.goalCelebrationAudio.currentTime = 0;
            this.goalCelebrationAudio.play()
                .then(() => console.log('üéâ Viking celebration lyd spiller!'))
                .catch(e => {
                    console.log('‚ö†Ô∏è Viking celebration lyd feilet, bruker scoring-lyd:', e);
                    this.playScoring();
                });
        } else {
            console.log('üéâ Celebration-fil ikke tilgjengelig, bruker scoring-lyd som fallback');
            this.playScoring();
        }
    }
};

// ===== INTRO-SEKVENS =====
function startIntroSequence() {
    if (introStarted) return;
    introStarted = true;
    
    console.log('üé¨ Starter intro-sekvens');
    
    simulateLoading();
    preloadMainAudio();
}

function simulateLoading() {
    const progressBar = document.getElementById('progressBar');
    const loadingTitle = document.getElementById('loadingTitle');
    
    const interval = setInterval(() => {
        loadingProgress += Math.random() * 3 + 1;
        
        if (loadingProgress >= 100) {
            loadingProgress = 100;
            clearInterval(interval);
            showStartButton();
        }
        
        if (progressBar) {
            progressBar.style.width = loadingProgress + '%';
        }
        
        if (loadingTitle) {
            if (loadingProgress < 30) {
                loadingTitle.textContent = 'üîä LASTER SPILLDATA...';
            } else if (loadingProgress < 70) {
                loadingTitle.textContent = 'üéµ LASTER SUPPORTER-LYD...';
            } else if (loadingProgress < 90) {
                loadingTitle.textContent = '‚öΩ FORBEREDER KAMPOPPSETT...';
            } else {
                loadingTitle.textContent = '‚úÖ KLAR TIL SPILL!';
            }
        }
    }, 200);
}

function preloadMainAudio() {
    if (!soundSystem.supporterAudio) return;
    
    soundSystem.supporterAudio.addEventListener('canplaythrough', () => {
        console.log('üéµ Hovedlyd ferdig lastet');
        loadingProgress = Math.max(loadingProgress, 80);
    });
    
    soundSystem.supporterAudio.addEventListener('progress', () => {
        if (soundSystem.supporterAudio.buffered.length > 0) {
            const buffered = soundSystem.supporterAudio.buffered.end(0);
            const duration = soundSystem.supporterAudio.duration;
            if (duration > 0) {
                const bufferProgress = (buffered / duration) * 100;
                console.log(`üéµ Buffer progress: ${bufferProgress.toFixed(1)}%`);
            }
        }
    });
    
    soundSystem.supporterAudio.currentTime = 0;
    soundSystem.supporterAudio.play().then(() => {
        soundSystem.supporterAudio.pause();
        soundSystem.supporterAudio.currentTime = 0;
    }).catch(e => {
        console.log('Preload av hovedlyd feilet, men det er ok');
    });
}

function showStartButton() {
    const startBtn = document.getElementById('startGameBtn');
    if (startBtn) {
        startBtn.style.display = 'block';
    }
}

function startMainGame() {
    const introScreen = document.getElementById('introScreen');
    const gameMessage = document.getElementById('gameMessage');
    
    soundSystem.stopIntro();
    
    if (introScreen) {
        introScreen.style.display = 'none';
    }
    
    // SKJUL NY SESONG-KNAPPEN
    if (gameMessage) {
        gameMessage.style.display = 'none';
    }
    
    console.log('üéÆ Starter hovedspill');
    
    setupFullScreenTouch();
    initializeGame();
}

// ===== KAMPDATA =====
const cupData = {
    vikingMatches: [
        { round: 1, opponent: "Hana", home: false },
        { round: 2, opponent: "Fl√∏y-Flekker√∏y", home: false },
        { round: 3, opponent: "Moss", home: false },
        { round: 4, opponent: "√Ösane", home: false },
        { round: 5, opponent: "Aalesund", home: false },
        { round: 6, opponent: "TBD", home: false },
        { round: 7, opponent: "TBD", home: false }
    ],

    roundNames: {
        1: "RUNDE 1", 2: "RUNDE 2", 3: "RUNDE 3", 4: "RUNDE 4",
        5: "KVARTFINALE", 6: "SEMIFINALE", 7: "FINALE"
    },

    fixedMatches: {
        5: [
            { team1: 'Aalesund', team2: 'Viking' },
            { team1: 'Rosenborg', team2: 'Sarpsborg 08' }, 
            { team1: 'Stab√¶k', team2: 'Kristiansund' },
            { team1: 'Lillestr√∏m', team2: 'KFUM' }
        ],
        6: [
            { team1: 'Viking', team2: 'TBD' },
            { team1: 'TBD', team2: 'TBD' }
        ],
        7: [
            { team1: 'TBD', team2: 'TBD' }
        ]
    },

    cupResults: {
        5: [],
        6: [],
        7: []
    },

    otherResults: {
        1: [
            { home: 'Innstranda', away: 'Bod√∏/Glimt', result: [0, 8] },
            { home: 'Os', away: 'Fana', result: [4, 2] },
            { home: 'Nordstrand', away: 'Ullensaker/Kisa', result: [5, 7] },
            { home: 'V√•g', away: 'Start', result: [2, 4] },
            { home: 'B√¶rum', away: 'Grorud', result: [6, 8] },
            { home: 'Ask√∏y', away: '√Ösane', result: [1, 5] },
            { home: 'Djerv 1919', away: 'Sotra', result: [2, 3] },
            { home: 'Gneist', away: 'Lysekloster', result: [0, 2] },
            { home: '√òrn Horten', away: 'Arendal', result: [5, 4] },
            { home: 'Torvastad', away: 'Vard Haugesund', result: [2, 0] },
            { home: '√Össiden', away: 'Mj√∏ndalen', result: [1, 4] },
            { home: 'Lillehammer', away: 'HamKam', result: [0, 2] },
            { home: 'Brumunddal', away: 'Raufoss', result: [1, 4] },
            { home: 'Elverum', away: 'Gj√∏vik-Lyn', result: [2, 0] },
            { home: 'Vindbjart', away: 'Jerv', result: [0, 3] },
            { home: 'Volda', away: 'Sogndal', result: [1, 2] },
            { home: 'Rollon', away: 'Aalesund', result: [0, 3] },
            { home: 'Spjelkavik', away: 'Tr√¶ff', result: [0, 2] },
            { home: 'Brattv√•g', away: 'H√∏dd', result: [4, 6] },
            { home: 'Flint', away: 'Odd', result: [3, 2] },
            { home: 'Bj√∏rkelangen', away: 'Str√∏mmen', result: [1, 6] },
            { home: 'Rindal', away: 'Rosenborg', result: [1, 11] },
            { home: 'Kvik', away: 'Stj√∏rdals-Blink', result: [0, 1] },
            { home: 'Verdal', away: 'Levanger', result: [0, 8] },
            { home: 'Trygg/Lade', away: 'Strindheim TF', result: [0, 1] },
            { home: 'By√•sen TF', away: 'Nardo', result: [3, 5] },
            { home: 'Melhus', away: 'Kristiansund', result: [1, 5] },
            { home: 'Elnesv√•gen', away: 'Molde', result: [0, 7] },
            { home: 'Fj√∏ra', away: 'Bjarg', result: [1, 3] },
            { home: 'Nord', away: 'Haugesund', result: [0, 11] },
            { home: 'Notodden', away: 'Stab√¶k', result: [0, 3] },
            { home: 'Konnerud', away: 'Str√∏msgodset', result: [0, 5] },
            { home: 'Ullern', away: 'Follo', result: [2, 5] },
            { home: 'Ready', away: 'Asker', result: [7, 6] },
            { home: 'R√•de', away: 'Lyn', result: [1, 2] },
            { home: 'Melbo', away: 'Sortland', result: [0, 1] },
            { home: 'Sprint-Jel√∏y ', away: 'Sarpsborg 08', result: [0, 4] },
            { home: 'Hamna', away: 'Troms√∏', result: [0, 10] },
            { home: 'Mosj√∏en IL', away: 'Rana FK', result: [0, 4] },
            { home: 'Varegg', away: 'Brann', result: [0, 6] },
            { home: 'H√∏nefoss BK', away: 'Pors', result: [0, 1] },
            { home: 'Grei', away: 'KFUM', result: [1, 5] },
            { home: 'Gamle Oslo', away: 'V√•lerenga', result: [4, 2] },
            { home: 'Vidar', away: 'Sandnes Ulf', result: [2, 0] },
            { home: 'Varhaug', away: 'Bryne', result: [0, 4] },
            { home: 'Fram Larvik', away: 'FK Eik T√∏nsberg 871', result: [4, 1] },
            { home: 'Ridabu', away: 'Kongsvinger', result: [0, 12] },
            { home: 'Sverresborg', away: 'Ranheim TF', result: [2, 4] },
            { home: 'Eiger', away: 'Egersund', result: [1, 7] },
            { home: 'Skjetten', away: 'Lillestr√∏m', result: [0, 5] },
            { home: 'Brodd', away: 'Fl√∏y-Flekker√∏y', result: [1, 3] },
            { home: 'Teie', away: 'Sandefjord Fotball', result: [0, 5] },
            { home: 'Kvik Halden', away: 'Moss', result: [1, 3] },
            { home: 'Skedsmo', away: 'Eidsvold TF', result: [0, 5] }
        ],
        2: [
            { home: 'Grorud', away: 'H√∏dd', result: [3, 1] },
            { home: 'Flint', away: 'Fredrikstad', result: [0, 5] },
            { home: 'Nardo', away: 'Kristiansund', result: [1, 4] },
            { home: 'Strindheim TF', away: 'Rosenborg', result: [0, 3] },
            { home: 'Stj√∏rdals-Blink', away: 'Ranheim TF', result: [1, 2] },
            { home: 'Torvastad', away: 'Bryne', result: [1, 2] },
            { home: '√òrn Horten', away: 'Sandefjord Fotball', result: [0, 2] },
            { home: 'Str√∏mmen', away: 'Raufoss', result: [2, 1] },
            { home: 'Os', away: 'Lysekloster', result: [5, 4] },
            { home: 'Sandviken', away: 'Sogndal', result: [0, 4] },
            { home: 'Vidar', away: 'Haugesund', result: [1, 2] },
            { home: 'Jerv', away: 'Egersund', result: [0, 1] },
            { home: 'Fram Larvik', away: 'Stab√¶k', result: [0, 4] },
            { home: 'Elverum', away: 'Kongsvinger', result: [2, 7] },
            { home: 'Ready', away: 'KFUM', result: [0, 3] },
            { home: 'Kjels√•s', away: 'Lyn', result: [0, 3] },
            { home: 'Sortland', away: 'Tromsdalen', result: [0, 5] },
            { home: 'Tr√¶ff', away: 'Molde', result: [12, 13] },
            { home: 'Bjarg', away: 'Brann', result: [0, 2] },
            { home: 'Sotra', away: '√Ösane', result: [0, 2] },
            { home: 'Pors', away: 'Start', result: [3, 2] },
            { home: 'Ullensaker/Kisa', away: 'Aalesund', result: [2, 3] },
            { home: 'L√∏renskog', away: 'HamKam', result: [0, 1] },
            { home: 'Follo', away: 'Moss', result: [2, 3] },
            { home: 'Gamle Oslo', away: 'Sarpsborg 08', result: [1, 6] },
            { home: 'Eidsvold TF', away: 'Lillestr√∏m', result: [0, 2] },
            { home: 'Mj√∏ndalen', away: 'Str√∏msgodset', result: [5, 4] }
        ],
        3: [
            { home: 'Os', away: '√Ösane', result: [1, 4] },
            { home: 'Bryne', away: 'Brann', result: [2, 1] },
            { home: 'Stab√¶k', away: 'Haugesund', result: [2, 1] },
            { home: 'Sarpsborg 08', away: 'Sandefjord Fotball', result: [3, 1] },
            { home: 'Grorud', away: 'Lillestr√∏m', result: [2, 3] },
            { home: 'Lyn', away: 'HamKam', result: [0, 2] },
            { home: 'Tromsdalen', away: 'Rosenborg', result: [0, 5] },
            { home: 'Rana FK', away: 'Molde', result: [0, 4] },
            { home: 'Pors', away: 'Fredrikstad', result: [1, 3] },
            { home: 'Str√∏mmen', away: 'Mj√∏ndalen', result: [1, 3] },
            { home: 'Sogndal', away: 'Kongsvinger', result: [6, 7] },
            { home: 'Ranheim TF', away: 'Egersund', result: [2, 5] },
            { home: 'Troms√∏', away: 'KFUM', result: [0, 1] },
            { home: 'Aalesund', away: 'Bod√∏/Glimt', result: [1, 0] }
        ],
        4: [
            { home: 'Egersund', away: 'Sarpsborg 08', result: [1, 3] },
            { home: 'Stab√¶k', away: 'Mj√∏ndalen', result: [4, 3] },
            { home: 'Aalesund', away: 'HamKam', result: [8, 7] },
            { home: 'Bryne', away: 'KFUM', result: [0, 2] },
            { home: 'Kongsvinger', away: 'Rosenborg', result: [2, 3] },
            { home: 'Lillestr√∏m', away: 'Fredrikstad', result: [4, 2] },
            { home: 'Molde', away: 'Kristiansund', result: [3, 4] }
        ]
    }
};

const teams = [
    { name: 'Bod√∏/Glimt', isSerieTeam: true, excelName: 'Bod√∏/Glimt', logo: 'bodo-glimt.png', difficulty: 3, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#FFD700', secondaryColor: '#FFD700', pattern: 'solid', players: [
        {name: 'Kasper H√∏gh', image: 'kasper-hogh', emoji: '‚öΩ', goals2025: 7},
        {name: 'Ulrik Saltnes', image: 'ulrik-saltnes', emoji: 'üí™', goals2025: 5},
        {name: 'Ole Blomberg', image: 'ole-blomberg', emoji: 'üéØ', goals2025: 3},
        {name: 'Jens Petter Hauge', image: 'jens-petter-hauge', emoji: 'üöÄ', goals2025: 1},
        {name: 'Patrick Berg', image: 'patrick-berg', emoji: 'üõ°Ô∏è', goals2025: 1}
    ]},
    { name: 'Rosenborg BK', isSerieTeam: true, excelName: 'Rosenborg', logo: 'rosenborg.png', difficulty: 3, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#FFFFFF', secondaryColor: '#000000', pattern: 'solid', players: [
        {name: 'Marius Broholm', image: 'marius-broholm', emoji: 'üëë', goals2025: 5},
        {name: 'Sverre Nypan', image: 'sverre-nypan', emoji: '‚ö°', goals2025: 2},
        {name: 'Ole S√¶ter', image: 'ole-seter', emoji: 'üéØ', goals2025: 1},
        {name: 'Adrian Pereira', image: 'adrian-pereira', emoji: 'üõ°Ô∏è', goals2025: 1},
        {name: 'Noah Holm', image: 'noah-holm', emoji: 'üí®', goals2025: 1}
    ]},
    { name: 'Molde FK', isSerieTeam: true, excelName: 'Molde', logo: 'molde-fk.jpg', difficulty: 3, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#4A90E2', secondaryColor: '#FFFFFF', pattern: 'solid', players: [
        {name: 'Kristian Eriksen', image: 'kristian-eriksen', emoji: '‚öΩ', goals2025: 3},
        {name: 'Veton Berisha', image: 'veton-berisha', emoji: 'üéØ', goals2025: 3},
        {name: 'Martin Linnes', image: 'martin-linnes', emoji: 'üíé', goals2025: 2},
        {name: 'Fredrik Gulbrandsen', image: 'fredrik-gulbrandsen', emoji: 'üí™', goals2025: 1},
        {name: 'Magnus Wolff Eikrem', image: 'magnus-wolff-eikrem', emoji: 'üöÄ', goals2025: 1}
    ]},
    { name: 'Brann', isSerieTeam: true, excelName: 'Brann', logo: 'brann.png', difficulty: 3, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#DC143C', secondaryColor: '#DC143C', pattern: 'solid', players: [
        {name: 'Aune Heggeb√∏', image: 'aune-heggebo', emoji: 'üëë', goals2025: 7},
        {name: 'Mads Sande', image: 'mads-sande', emoji: 'üíé', goals2025: 3},
        {name: 'B√•rd Finne', image: 'bard-finne', emoji: 'üí•', goals2025: 3},
        {name: 'Niklas Castro', image: 'niklas-castro', emoji: 'üéØ', goals2025: 3},
        {name: 'Emil Kornvig', image: 'emil-kornvig', emoji: '‚ö°', goals2025: 2}
    ]},
    { name: 'Fredrikstad', isSerieTeam: true, excelName: 'Fredrikstad', logo: 'fredrikstad.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#DC143C', secondaryColor: '#FFFFFF', pattern: 'solid', players: [
        {name: 'Sondre S√∏rl√∏kk', image: 'sondre-sorlokk', emoji: '‚öΩ', goals2025: 3},
        {name: 'Emil Holten', image: 'emil-holten', emoji: 'üéØ', goals2025: 3},
        {name: 'Oskar √òhlenschl√¶ger', image: 'oskar-ohlenschlaeger', emoji: '‚ú®', goals2025: 2},
        {name: 'Fallou Fall', image: 'fallou-fall', emoji: 'üí™', goals2025: 1},
        {name: 'Stian Molde', image: 'stian-molde', emoji: 'üõ°Ô∏è', goals2025: 1}
    ]},
    { name: 'V√•lerenga', isSerieTeam: true, excelName: 'V√•lerenga', logo: 'valerenga.png', difficulty: 3, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#4A90E2', secondaryColor: '#DC143C', pattern: 'stripe_thin', players: [
        {name: 'Elias S√∏rensen', image: 'elias-sorensen', emoji: '‚öΩ', goals2025: 3},
        {name: 'Magnus Riisn√¶s', image: 'magnus-riisnes', emoji: 'üíé', goals2025: 2},
        {name: 'Henrik Bj√∏rdal', image: 'henrik-bjordal', emoji: '‚ö°', goals2025: 2},
        {name: 'Fidel Ambina', image: 'fidel-ambina', emoji: 'üöÄ', goals2025: 1},
        {name: 'Muamer Brajanac', image: 'muamer-brajanac', emoji: 'üéØ', goals2025: 1}
    ]},
    { name: 'KFUM Oslo', isSerieTeam: true, excelName: 'KFUM', logo: 'kfum-oslo.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#FF6B6B', secondaryColor: '#4A90E2', pattern: 'tricolor', players: [
        {name: 'Moussa Njie', image: 'moussa-njie', emoji: '‚öΩ', goals2025: 2},
        {name: 'Johannes Nunez', image: 'johannes-nunez', emoji: 'üéØ', goals2025: 2},
        {name: 'Simen Hestnes', image: 'simen-hestnes', emoji: 'üíé', goals2025: 1},
        {name: 'Mame Ndiaye', image: 'mame-ndiaye', emoji: 'üí™', goals2025: 1},
        {name: 'Teodor Haltvik', image: 'teodor-haltvik', emoji: 'üõ°Ô∏è', goals2025: 0}
    ]},
    { name: 'Haugesund', isSerieTeam: true, excelName: 'Haugesund', logo: 'haugesund.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#FFFFFF', secondaryColor: '#4A90E2', pattern: 'solid', players: [
        {name: 'Madiodio Dia', image: 'madiodio-dia', emoji: '‚öΩ', goals2025: 1},
        {name: 'Julius Eskesen', image: 'julius-eskesen', emoji: 'üéØ', goals2025: 1},
        {name: 'Sory Ibrahim Diarra', image: 'sory-ibrahim-diarra', emoji: 'üí™', goals2025: 1},
        {name: 'Troy Nyhammer', image: 'troy-nyhammer', emoji: 'üöÄ', goals2025: 0},
        {name: 'Bruno Leite', image: 'bruno-leite', emoji: '‚ö°', goals2025: 0}
    ]},
    { name: 'Kristiansund BK', isSerieTeam: true, excelName: 'Kristiansund', logo: 'kristiansund.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#708090', secondaryColor: '#708090', pattern: 'solid', players: [
        {name: 'David Tufekcic', image: 'david-tufekcic', emoji: '‚öΩ', goals2025: 3},
        {name: 'Sander Kilen', image: 'sander-kilen', emoji: 'üéØ', goals2025: 3},
        {name: 'Ruben Alte', image: 'ruben-alte', emoji: 'üíé', goals2025: 2},
        {name: 'Alioune Ndour', image: 'alioune-ndour', emoji: 'üí™', goals2025: 2},
        {name: 'Rezan Corlu', image: 'rezan-corlu', emoji: 'üöÄ', goals2025: 1}
    ]},
    { name: 'Sarpsborg 08', isSerieTeam: true, excelName: 'Sarpsborg 08', logo: 'sarpsborg.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#87CEEB', secondaryColor: '#FFFFFF', pattern: 'stripes', players: [
        {name: 'Daniel Karlsbakk', image: 'daniel-karlsbakk', emoji: '‚öΩ', goals2025: 6},
        {name: 'Harald Nilsen Tangen', image: 'harald-nilsen-tangen', emoji: 'üíé', goals2025: 2},
        {name: 'Frederik Carstensen', image: 'frederik-carstensen', emoji: 'üéØ', goals2025: 2},
        {name: 'Sveinn Gudjohnsen', image: 'sveinn-gudjohnsen', emoji: 'üí™', goals2025: 2},
        {name: 'Sondre √òrjas√¶ter', image: 'sondre-orjaseter', emoji: '‚ö°', goals2025: 1}
    ]},
    { name: 'Sandefjord', isSerieTeam: true, excelName: 'Sandefjord Fotball', logo: 'sandefjord.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#4169E1', secondaryColor: '#4169E1', pattern: 'solid', players: [
        {name: 'Stefan Sigurdarson', image: 'stefan-sigurdarson', emoji: '‚öΩ', goals2025: 5},
        {name: 'Jakob Dunsby', image: 'jakob-dunsby', emoji: 'üéØ', goals2025: 2},
        {name: 'Christopher Cheng', image: 'christopher-cheng', emoji: 'üí™', goals2025: 2},
        {name: 'Zinedin Smajlovic', image: 'zinedin-smajlovic', emoji: '‚ö°', goals2025: 1},
        {name: 'Sander M√∏rk', image: 'sander-mork', emoji: 'üíé', goals2025: 1}
    ]},
    { name: 'Str√∏msgodset', isSerieTeam: true, excelName: 'Str√∏msgodset', logo: 'stromsgodset.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#1E3A8A', secondaryColor: '#FFFFFF', pattern: 'stripes', players: [
        {name: 'Marko Farji', image: 'marko-farji', emoji: '‚öΩ', goals2025: 5},
        {name: 'Jonas Therkelsen', image: 'jonas-therkelsen', emoji: 'üéØ', goals2025: 2},
        {name: 'Logi T√≥masson', image: 'logi-tomasson', emoji: 'üí™', goals2025: 1},
        {name: 'Fredrik Dahl', image: 'fredrik-dahl', emoji: 'üíé', goals2025: 1},
        {name: 'Herman Stengel', image: 'herman-stengel', emoji: 'üöÄ', goals2025: 1}
    ]},
    { name: 'Troms√∏ IL', isSerieTeam: true, excelName: 'Troms√∏', logo: 'tromso.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#DC143C', secondaryColor: '#FFFFFF', pattern: 'stripes', players: [
        {name: 'Daniel Braut', image: 'daniel-braut', emoji: '‚öΩ', goals2025: 5},
        {name: 'Ieltsin Cam√µes', image: 'ieltsin-camoes', emoji: 'üéØ', goals2025: 3},
        {name: 'Vetle Skj√¶rvik', image: 'vetle-skjaervik', emoji: 'üíé', goals2025: 2},
        {name: 'August Mikkelsen', image: 'august-mikkelsen', emoji: 'üí™', goals2025: 1},
        {name: 'Jakob Napoleon Romsaas', image: 'jakob-napoleon-romsaas', emoji: '‚ö°', goals2025: 1}
    ]},
    { name: 'HamKam', isSerieTeam: true, excelName: 'HamKam', logo: 'hamkam.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#228B22', secondaryColor: '#FFFFFF', pattern: 'stripes', players: [
        {name: 'Moses Mawa', image: 'moses-mawa', emoji: '‚öΩ', goals2025: 2},
        {name: 'Kristian Lien', image: 'kristian-lien', emoji: 'üéØ', goals2025: 2},
        {name: 'Snorre Nilsen', image: 'snorre-nilsen', emoji: 'üíé', goals2025: 1},
        {name: 'Alwande Roalds√∏y', image: 'alwande-roaldsoy', emoji: 'üí™', goals2025: 1},
        {name: 'Tore S√∏r√•s', image: 'tore-soras', emoji: '‚ö°', goals2025: 1}
    ]},
    { name: 'Bryne FK', isSerieTeam: true, excelName: 'Bryne', logo: 'bryne.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#DC143C', secondaryColor: '#FFFFFF', pattern: 'stripes', players: [
        {name: 'Duarte Moreira', image: 'duarte-moreira', emoji: '‚öΩ', goals2025: 4},
        {name: 'Sanel Bojadzic', image: 'sanel-bojadzic', emoji: 'üéØ', goals2025: 3},
        {name: 'Nicklas Jakobsen', image: 'nicklas-jakobsen', emoji: 'üíé', goals2025: 2},
        {name: 'Alfred Scriven', image: 'alfred-scriven', emoji: 'üí™', goals2025: 2},
        {name: 'Axel Kryger', image: 'axel-kryger', emoji: '‚ö°', goals2025: 1}
    ]},
    { name: 'Hana IL', excelName: 'Hana', logo: 'hana.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#228B22', secondaryColor: '#FFFFFF', pattern: 'stripes', players: [
        {name: 'Eirik Skavhaug Larsson', image: 'eirik-skavhaug-larsson', emoji: '‚öΩ', goals2025: 2},
        {name: 'Brede Fiksdal', image: 'brede-fiksdal', emoji: 'üéØ', goals2025: 1},
        {name: 'Theo Svihus Gramstad', image: 'theo-svihus-gramstad', emoji: 'üí™', goals2025: 1},
        {name: 'Thomas Gabriel Minde', image: 'thomas-gabriel-minde', emoji: 'üöÄ', goals2025: 0}
    ]},
    { name: 'Fl√∏y-Flekker√∏y', excelName: 'Fl√∏y-Flekker√∏y', logo: 'floy-flekkeroy.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#4A90E2', secondaryColor: '#FFFFFF', pattern: 'stripes', players: [
        {name: 'Henrik Byklum', image: 'henrik-byklum', emoji: '‚öΩ', goals2025: 3},
        {name: 'Dirirsa Gamachis', image: 'dirirsa-gamachis', emoji: 'üéØ', goals2025: 2},
        {name: 'William Drange Johnsen', image: 'william-drange-johnsen', emoji: 'üíé', goals2025: 1},
        {name: 'Elias Simossa Rike Nahiry', image: 'elias-simossa-rike-nahiry', emoji: 'üí™', goals2025: 1}
    ]},
    { name: 'Moss FK', excelName: 'Moss', logo: 'moss.png', difficulty: 2, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#FFD700', secondaryColor: '#000000', pattern: 'solid', players: [
        {name: 'Bo √Ösulv Hegland', image: 'bo-asulv-hegland', emoji: 'üëë', goals2025: 4},
        {name: 'Blerton Isufi', image: 'blerton-isufi', emoji: '‚öΩ', goals2025: 3},
        {name: 'Artan Memedov', image: 'artan-memedov', emoji: 'üéØ', goals2025: 2},
        {name: 'Alexander Lien H√•pnes', image: 'alexander-lien-hapnes', emoji: 'üí™', goals2025: 1}
    ]},
    { name: '√Ösane Fotball', excelName: '√Ösane', logo: 'asane.png', difficulty: 3, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#DC143C', secondaryColor: '#FFFFFF', pattern: 'stripes', players: [
        {name: 'Erling Flotve Myklebust', image: 'erling-flotve-myklebust', emoji: '‚öΩ', goals2025: 3},
        {name: 'Steffen Lie Sk√•levik', image: 'steffen-lie-skalevik', emoji: 'üéØ', goals2025: 2},
        {name: 'Kristoffer Ramos Barmen', image: 'kristoffer-ramos-barmen', emoji: 'üíé', goals2025: 1},
        {name: 'Sebastian Heimvik Haugland', image: 'sebastian-heimvik-haugland', emoji: 'üí™', goals2025: 1}
    ]},
    { name: 'Aalesund', excelName: 'Aalesund', logo: 'aalesund.png', difficulty: 3, played: 0, won: 0, lost: 0, points: 0, goalsFor: 0, goalsAgainst: 0, color: '#FFA500', secondaryColor: '#FFFFFF', pattern: 'solid', players: [
        {name: 'David Sn√¶r Johannsson', image: 'david-snaer-johannsson', emoji: 'üëë', goals2025: 6},
        {name: 'Claudio Rafael Soares Braga', image: 'claudio-rafael-soares-braga', emoji: '‚öΩ', goals2025: 4},
        {name: 'H√•kon Butli Hammer', image: 'hakon-butli-hammer', emoji: 'üéØ', goals2025: 3},
        {name: 'Paul Ngongo Iversen', image: 'paul-ngongo-iversen', emoji: 'üí™', goals2025: 2}
    ]}
];

const vikingSchedule = [
    { index: 0, date: '2025-03-29', type: 'serie', round: 1, opponent: 'V√•lerenga', home: false },
    { index: 1, date: '2025-04-05', type: 'serie', round: 2, opponent: 'KFUM Oslo', home: true },
    { index: 2, date: '2025-04-13', type: 'cup', round: 1, opponent: 'Hana', home: false },
    { index: 3, date: '2025-04-20', type: 'serie', round: 3, opponent: 'HamKam', home: false },
    { index: 4, date: '2025-04-24', type: 'cup', round: 2, opponent: 'Fl√∏y-Flekker√∏y', home: false },
    { index: 5, date: '2025-04-27', type: 'serie', round: 4, opponent: 'Troms√∏', home: true },
    { index: 6, date: '2025-05-02', type: 'serie', round: 5, opponent: 'Sarpsborg 08', home: true },
    { index: 7, date: '2025-05-07', type: 'cup', round: 3, opponent: 'Moss', home: false },
    { index: 8, date: '2025-05-11', type: 'serie', round: 6, opponent: 'Haugesund', home: false },
    { index: 9, date: '2025-05-16', type: 'serie', round: 7, opponent: 'Sandefjord', home: true },
    { index: 10, date: '2025-05-20', type: 'cup', round: 4, opponent: '√Ösane', home: false },
    { index: 11, date: '2025-05-24', type: 'serie', round: 8, opponent: 'Kristiansund', home: false },
    { index: 12, date: '2025-05-31', type: 'serie', round: 9, opponent: 'Molde', home: false },
    { index: 13, date: '2025-06-21', type: 'serie', round: 10, opponent: 'Fredrikstad', home: true },
    { index: 14, date: '2025-06-25', type: 'cup', round: 5, opponent: 'Aalesund', home: false },
    { index: 15, date: '2025-06-28', type: 'serie', round: 11, opponent: 'Rosenborg', home: false },
    { index: 16, date: '2025-07-05', type: 'cup', round: 6, opponent: 'TBD', home: false },
    { index: 17, date: '2025-07-12', type: 'serie', round: 12, opponent: 'Str√∏msgodset', home: true },
    { index: 18, date: '2025-07-15', type: 'cup', round: 7, opponent: 'TBD', home: false },
    { index: 19, date: '2025-07-19', type: 'serie', round: 13, opponent: 'Brann', home: false },
    { index: 20, date: '2025-07-26', type: 'serie', round: 14, opponent: 'Bod√∏/Glimt', home: true },
    { index: 21, date: '2025-08-09', type: 'serie', round: 15, opponent: 'Bryne', home: false },
    { index: 22, date: '2025-08-16', type: 'serie', round: 16, opponent: 'Kristiansund', home: true },
    { index: 23, date: '2025-08-23', type: 'serie', round: 17, opponent: 'Sandefjord', home: false },
    { index: 24, date: '2025-08-30', type: 'serie', round: 18, opponent: 'Haugesund', home: true },
    { index: 25, date: '2025-09-13', type: 'serie', round: 19, opponent: 'Bod√∏/Glimt', home: false },
    { index: 26, date: '2025-09-20', type: 'serie', round: 20, opponent: 'Rosenborg', home: true },
    { index: 27, date: '2025-09-27', type: 'serie', round: 21, opponent: 'KFUM Oslo', home: false },
    { index: 28, date: '2025-10-04', type: 'serie', round: 22, opponent: 'Molde', home: true },
    { index: 29, date: '2025-10-18', type: 'serie', round: 23, opponent: 'Sarpsborg 08', home: false },
    { index: 30, date: '2025-10-25', type: 'serie', round: 24, opponent: 'Brann', home: true },
    { index: 31, date: '2025-11-01', type: 'serie', round: 25, opponent: 'Troms√∏', home: false },
    { index: 32, date: '2025-11-08', type: 'serie', round: 26, opponent: 'Bryne', home: true },
    { index: 33, date: '2025-11-22', type: 'serie', round: 27, opponent: 'Str√∏msgodset', home: false },
    { index: 34, date: '2025-11-29', type: 'serie', round: 28, opponent: 'HamKam', home: true },
    { index: 35, date: '2025-12-06', type: 'serie', round: 29, opponent: 'Fredrikstad', home: false },
    { index: 36, date: '2025-12-13', type: 'serie', round: 30, opponent: 'V√•lerenga', home: true }
];

window.vikingTeam = {
    name: 'Viking FK',
    logo: 'viking-fk.png',
    color: '#002166',
    secondaryColor: '#FFFFFF',
    played: 0,
    won: 0,
    lost: 0,
    draws: 0,
    points: 0,
    goalsFor: 0,
    goalsAgainst: 0,
    players: [
        {name: 'Zlatko Tripic', image: 'zlatko-tripic', emoji: 'üëë', goals2025: 8},
        {name: 'Peter Christiansen', image: 'peter-christiansen', emoji: '‚öΩ', goals2025: 4},
        {name: 'Henrik Falchener', image: 'henrik-falchener', emoji: 'üéØ', goals2025: 3},
        {name: 'Edvin Austb√∏', image: 'edvin-austbo', emoji: 'üíé', goals2025: 3},
        {name: 'Simen Kvia-Egeskog', image: 'simen-kvia-egeskog', emoji: 'üí™', goals2025: 3},
        {name: 'Henrik Heggheim', image: 'henrik-heggheim', emoji: 'üõ°Ô∏è', goals2025: 2},
        {name: 'Herman Haugen', image: 'herman-haugen', emoji: '‚ö°', goals2025: 1},
        {name: 'Joe Bell', image: 'joe-bell', emoji: 'üöÄ', goals2025: 1}
    ]
};

const vikingTeam = window.vikingTeam;

// ===== HJELPEFUNKSJONER =====
function getCurrentOpponent() {
    if (gameState.currentMatchIndex >= vikingSchedule.length) {
        return null;
    }
    
    const currentMatch = vikingSchedule[gameState.currentMatchIndex];
    
    if (currentMatch.type === 'cup' && gameState.cupEliminated) {
        gameState.currentMatchIndex++;
        return getCurrentOpponent();
    }
    
    let team = findTeamByName(currentMatch.opponent);
    if (team) {
        return team;
    }
    
    return {
        name: currentMatch.opponent,
        excelName: currentMatch.opponent,
        difficulty: 3,
        color: '#888888',
        secondaryColor: '#FFFFFF',
        pattern: 'solid',
        logo: 'unknown.png',
        players: [
            {name: 'Ukjent Spiller', emoji: '‚öΩ', image: 'unknown', goals2025: 0}
        ]
    };
}

function findTeamByName(name) {
    if (!name) return null;

    let team = teams.find(team => team.name === name);
    if (team) return team;
    
    team = teams.find(team => team.name.includes(name) || name.includes(team.name.split(' ')[0]));
    if (team) return team;
    
    return teams.find(team => team.excelName === name);
}

function getRandomPlayer(team) {
    if (!team || !team.players || !Array.isArray(team.players) || team.players.length === 0) {
        return null;
    }
    
    const randomIndex = Math.floor(Math.random() * team.players.length);
    return team.players[randomIndex];
}

function addToTopScorers(player, team) {
    // Kun legg til i serie-toppscorere hvis det er et serielag
    if (!team.isSerieTeam && team.name !== 'Viking FK') {
        return;
    }
    
    const existingScorer = gameState.topScorers.find(s => s.name === player.name && s.team === team.name);
    if (existingScorer) {
        existingScorer.goals++;
    } else {
        gameState.topScorers.push({
            name: player.name,
            team: team.name,
            goals: 1,
            emoji: player.emoji || '‚öΩ'
        });
    }
    gameState.topScorers.sort((a, b) => b.goals - a.goals);
}

function addToCupTopScorers(player, team) {
    if (!player || !team || !player.name || !team.name) return;
    
    const existingScorer = cupTopScorers.find(s => s.name === player.name && s.team === team.name);
    if (existingScorer) {
        existingScorer.goals++;
    } else {
        cupTopScorers.push({
            name: player.name,
            team: team.name,
            goals: 1,
            emoji: player.emoji || '‚öΩ'
        });
    }
}

function generateOtherResults() {
    const currentOpponent = getCurrentOpponent();
    
    // Kun serielag i andre resultater
    const serieLag = teams.filter(team => team.isSerieTeam === true);
    const otherTeams = serieLag.filter(team => team.name !== currentOpponent?.name);
    
    const results = [];

    for (let i = 0; i < otherTeams.length - 1; i += 2) {
        if (otherTeams[i + 1]) {
            const team1 = otherTeams[i];
            const team2 = otherTeams[i + 1];
            const team1Strength = 6 - team1.difficulty;
            const team2Strength = 6 - team2.difficulty;

            let team1Goals = Math.floor(Math.random() * 4);
            let team2Goals = Math.floor(Math.random() * 4);

            if (team1Strength > team2Strength) {
                team1Goals += Math.floor(Math.random() * 2);
            } else if (team2Strength > team1Strength) {
                team2Goals += Math.floor(Math.random() * 2);
            }

            // Oppdater m√•l for/imot
            team1.goalsFor += team1Goals;
            team1.goalsAgainst += team2Goals;
            team2.goalsFor += team2Goals;
            team2.goalsAgainst += team1Goals;

            // Oppdater poeng og statistikk (inkludert uavgjort)
            if (team1Goals > team2Goals) {
                team1.won++;
                team1.points += 3;
                team2.lost++;
            } else if (team2Goals > team1Goals) {
                team2.won++;
                team2.points += 3;
                team1.lost++;
            } else {
                // UAVGJORT
                team1.draws++;
                team1.points += 1;
                team2.draws++;
                team2.points += 1;
            }

            team1.played++;
            team2.played++;

            // Legg til m√•lscorere for andre lag
            for (let j = 0; j < team1Goals; j++) {
                const scorer = getRandomPlayer(team1);
                if (scorer) addToTopScorers(scorer, team1);
            }
            for (let j = 0; j < team2Goals; j++) {
                const scorer = getRandomPlayer(team2);
                if (scorer) addToTopScorers(scorer, team2);
            }

            results.push({
                team1: team1.name,
                team1Goals: team1Goals,
                team2Goals: team2Goals,
                team2: team2.name
            });
        }
    }

    return results;
}

function updateOpponentJersey() {
    const opponent = document.getElementById('opponent');
    const currentTeam = getCurrentOpponent();
    if (!currentTeam || !opponent) return;
    
    const primaryColor = currentTeam.color;
    const secondaryColor = currentTeam.secondaryColor;

    switch(currentTeam.pattern) {
        case 'stripes':
            opponent.style.background = `repeating-linear-gradient(90deg, ${primaryColor} 0px, ${primaryColor} 6px, ${secondaryColor} 6px, ${secondaryColor} 12px)`;
            break;
        case 'stripe_thin':
            opponent.style.background = `linear-gradient(90deg, ${primaryColor} 0%, ${primaryColor} 45%, ${secondaryColor} 47%, ${secondaryColor} 53%, ${primaryColor} 55%, ${primaryColor} 100%)`;
            break;
        case 'tricolor':
            opponent.style.background = `linear-gradient(0deg, ${secondaryColor} 0%, ${secondaryColor} 33%, #FFFFFF 33%, #FFFFFF 66%, ${primaryColor} 66%, ${primaryColor} 100%)`;
            break;
        case 'solid':
        default:
            opponent.style.background = `linear-gradient(180deg, ${primaryColor}, ${primaryColor}dd, ${primaryColor})`;
            break;
    }
}

function updateNextCupOpponent(completedRound) {
    if (completedRound === 5) { // Etter kvartfinale
        // Generer semifinale-motstandere
        const semiResults = [
            { team1: 'Rosenborg', team2: 'Sarpsborg 08', winner: Math.random() > 0.5 ? 'Rosenborg' : 'Sarpsborg 08' },
            { team1: 'Stab√¶k', team2: 'Kristiansund', winner: Math.random() > 0.5 ? 'Stab√¶k' : 'Kristiansund' },
            { team1: 'Lillestr√∏m', team2: 'KFUM', winner: Math.random() > 0.5 ? 'Lillestr√∏m' : 'KFUM' }
        ];
        
        // Oppdater Viking sin semifinale-motstander
        const vikingSemiOpponent = semiResults[0].winner;
        const otherSemiMatch = [semiResults[1].winner, semiResults[2].winner];
        
        // Oppdater vikingSchedule
        const semiMatch = vikingSchedule.find(m => m.type === 'cup' && m.round === 6);
        if (semiMatch) {
            semiMatch.opponent = vikingSemiOpponent;
        }
        
        // Oppdater fixedMatches for semifinale
        cupData.fixedMatches[6] = [
            { team1: 'Viking', team2: vikingSemiOpponent },
            { team1: otherSemiMatch[0], team2: otherSemiMatch[1] }
        ];
        
        // Generer kvartfinale-resultater for andre kamper
        cupData.cupResults[5] = semiResults.map(result => ({
            team1: result.team1,
            team1Goals: result.winner === result.team1 ? 2 : 1,
            team2Goals: result.winner === result.team2 ? 2 : 1,
            team2: result.team2
        }));
        
    } else if (completedRound === 6) { // Etter semifinale
        // Bestem finale-motstander
        const otherSemiWinner = Math.random() > 0.5 ? 
            cupData.fixedMatches[6][1].team1 : cupData.fixedMatches[6][1].team2;
       // Oppdater fixedMatches for finale
        cupData.fixedMatches[7] = [
            { team1: 'Viking', team2: otherSemiWinner }
        ];
        
        // Generer semifinale-resultater
        cupData.cupResults[6] = [
            {
                team1: cupData.fixedMatches[6][1].team1,
                team1Goals: otherSemiWinner === cupData.fixedMatches[6][1].team1 ? 2 : 1,
                team2Goals: otherSemiWinner === cupData.fixedMatches[6][1].team2 ? 2 : 1,
                team2: cupData.fixedMatches[6][1].team2
            }
        ];
    }
}

function initializeCupTopScorers() {
    console.log('üéØ Initializing cup top scorers...');
    cupTopScorers = [];
    
    // Generer m√•l fra alle hardkodede cup-resultater
    Object.values(cupData.otherResults).flat().forEach(match => {
        const [homeGoals, awayGoals] = match.result;
        
        // Hjemmelag m√•l
        if (homeGoals > 0) {
            const homeTeam = findTeamByName(match.home);
            if (homeTeam) {
                for (let i = 0; i < homeGoals; i++) {
                    const scorer = getRandomPlayer(homeTeam);
                    if (scorer) addToCupTopScorers(scorer, homeTeam);
                }
            } else {
                const dummyTeam = { 
                    name: match.home, 
                    players: [
                        {name: 'Lokal helt', emoji: '‚öΩ'},
                        {name: 'Va goe ein gang', emoji: 'üèÜ'},
                        {name: 'Sykt talent', emoji: 'üéØ'}
                    ]
                };
                for (let i = 0; i < homeGoals; i++) {
                    const scorer = getRandomPlayer(dummyTeam);
                    addToCupTopScorers(scorer, dummyTeam);
                }
            }
        }
        
        // Samme for bortelag
        if (awayGoals > 0) {
            const awayTeam = findTeamByName(match.away);
            if (awayTeam) {
                for (let i = 0; i < awayGoals; i++) {
                    const scorer = getRandomPlayer(awayTeam);
                    if (scorer) addToCupTopScorers(scorer, awayTeam);
                }
            } else {
                const dummyTeam = { 
                    name: match.away, 
                    players: [
                        {name: 'Lokalhelt', emoji: '‚öΩ'},
                        {name: 'Cuphelt', emoji: 'üèÜ'},
                        {name: 'Matchvinner', emoji: 'üéØ'}
                    ]
                };
                for (let i = 0; i < awayGoals; i++) {
                    const scorer = getRandomPlayer(dummyTeam);
                    addToCupTopScorers(scorer, dummyTeam);
                }
            }
        }
    });
    
    cupTopScorers.sort((a, b) => b.goals - a.goals);
    console.log('‚úÖ Cup top scorers initialized:', cupTopScorers.length, 'scorers');
}

function initializeGame() {
    console.log('üéÆ Initializing mobile game...');
    
    // Optimaliser for mobil
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
    document.body.style.height = '100%';
    
    // Skjul address bar
    setTimeout(() => {
        window.scrollTo(0, 1);
    }, 100);

    // SKJUL GAMEMESSAGE VED OPPSTART
    const gameMessage = document.getElementById('gameMessage');
    if (gameMessage) {
        gameMessage.style.display = 'none';
    }

    initializeCupTopScorers();
    
    // DOM-elementer
    const gameField = document.getElementById('gameField');
    const viking = document.getElementById('viking');
    const opponent = document.getElementById('opponent');
    const ball = document.getElementById('ball');
    const touchArea = document.getElementById('touchArea');

    // Initialiser mobil-posisjoner
    const fieldWidth = gameField ? gameField.offsetWidth : window.innerWidth;
    gameState.vikingX = fieldWidth / 2 - 40;
    gameState.opponentX = fieldWidth / 2 - 40;
    gameState.ballX = fieldWidth / 2;
    gameState.ballY = 350;

    // ===== FORBEDRET BALLBEVEGELSE =====

    function showCountdown(callback, text = "KAMPSTART") {
        gameState.gameActive = false;
        
        const countdownDiv = document.createElement('div');
        countdownDiv.id = 'countdown';
        countdownDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #000000, #1a1a1a);
            color: #FFD700;
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            border: 4px solid #FFD700;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
            font-family: 'Courier New', monospace;
            backdrop-filter: blur(10px);
        `;
        
        countdownDiv.innerHTML = `
            <div style="font-size: 20px; margin-bottom: 20px; color: #00FF00; white-space: nowrap;">${text}</div>
            <div id="countdownNumber" style="font-size: 80px; font-weight: bold; transition: all 0.3s ease;">3</div>
        `;
        
        document.body.appendChild(countdownDiv);
        
        let count = 3;
        const countdownNumber = document.getElementById('countdownNumber');
        
        const interval = setInterval(() => {
            count--;
            if (count > 0) {
                countdownNumber.textContent = count;
                countdownNumber.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    countdownNumber.style.transform = 'scale(1)';
                }, 200);
            } else {
                document.body.removeChild(countdownDiv);
                callback();
                clearInterval(interval);
            }
        }, 1000);
    }

    function kickOff(team) {
        console.log('üèà kickOff called for:', team);
        gameState.lastKickoffTime = Date.now();

        // KOMPLETT NULLSTILLING F√òRST
        gameState.ballVelX = 0;
        gameState.ballVelY = 0;
        
        // MOBIL: Ball starter i midten og g√•r vertikalt
        const fieldRect = gameField.getBoundingClientRect();
        const fieldWidth = fieldRect.width - 40;
        const fieldHeight = fieldRect.height - 40;
        
        gameState.ballX = fieldWidth / 2;
        gameState.ballY = fieldHeight / 2;
        
        setTimeout(() => {
            if (team === 'viking') {
                gameState.ballVelY = -4; // Ball g√•r oppover (mot motstander)
            } else {
                gameState.ballVelY = 4;  // Ball g√•r nedover (mot viking)
            }
            
            // Litt tilfeldig X-hastighet
            gameState.ballVelX = (Math.random() - 0.5) * 4;
            
            console.log('üöÄ MOBIL Ball hastighet satt:', gameState.ballVelX, gameState.ballVelY);
        }, 100);
        
        const ball = document.getElementById('ball');
        if (ball) {
            // BRUK TRANSFORM i stedet for left/top for bedre ytelse
            ball.style.transform = `translate(${gameState.ballX}px, ${gameState.ballY}px)`;
        }
        
        soundSystem.playWhistle();
        soundSystem.startSupporters();
    }

    function goalScored(scorer) {
        if (gameState.halfTimeBreak || gameState.matchTime >= 90) {
            console.log('üö´ M√•l ignorert - kampause eller kampen er ferdig');
            return;
        }
        gameState.gameActive = false;

        let goalScorer;
        let isVikingFifthGoal = false;
        
        if (scorer === 'viking') {
            gameState.vikingScore++;
            goalScorer = getRandomPlayer(vikingTeam);
            
            // SPILL SCORING-LYD UMIDDELBART
            soundSystem.playScoring();
            
            if (gameState.vikingScore === 5) {
                isVikingFifthGoal = true;
                setTimeout(() => {
                    if (soundSystem.goalCelebrationAudio) {
                        soundSystem.goalCelebrationAudio.currentTime = 0;
                        soundSystem.goalCelebrationAudio.play();
                    }
                }, 1000);
            }
            
            const currentMatch = vikingSchedule[gameState.currentMatchIndex];
            if (currentMatch && currentMatch.type === 'cup') {
                addToCupTopScorers(goalScorer, vikingTeam);
            } else {
                addToTopScorers(goalScorer, vikingTeam);
            }
            
            if (checkForVAR(scorer, goalScorer, vikingTeam, isVikingFifthGoal)) {
                return;
            } else {
                showGoalScorerDisplay(goalScorer, vikingTeam);
                
                setTimeout(() => {
                    kickOff(scorer === 'viking' ? 'opponent' : 'viking');
                    gameState.gameActive = true;
                }, 4000);
            }
        
        } else {
            gameState.opponentScore++;
            const currentOpponentTeam = getCurrentOpponent();
            goalScorer = getRandomPlayer(currentOpponentTeam);
            
            const currentMatch = vikingSchedule[gameState.currentMatchIndex];
            if (currentMatch && currentMatch.type === 'cup') {
                addToCupTopScorers(goalScorer, currentOpponentTeam);
            } else {
                addToTopScorers(goalScorer, currentOpponentTeam);
            }
            
            if (checkForVAR(scorer, goalScorer, currentOpponentTeam, false)) {
                return;
            } else {
                showGoalScorerDisplay(goalScorer, currentOpponentTeam);
                
                setTimeout(() => {
                    kickOff(scorer === 'viking' ? 'opponent' : 'viking');
                    gameState.gameActive = true;
                }, 4000);
            }
        }

        updateUI();
    }

    // FORBEDRET BALLBEVEGELSE MED DELTATIME
    function updateBall() {
        if (gameState.paused) return;
        
        // Beregn deltaTime for jevnere bevegelse
        const currentTime = Date.now();
        const deltaTime = Math.min((currentTime - lastFrameTime) / 16.67, 2); // Maks 2x normal hastighet
        lastFrameTime = currentTime;
        
        // SJEKK KOLLISJON F√òRST
        checkPlayerCollisions();
        
        // Oppdater posisjon med deltaTime
        gameState.ballX += gameState.ballVelX * deltaTime;
        gameState.ballY += gameState.ballVelY * deltaTime;

        const fieldRect = gameField.getBoundingClientRect();
        const fieldWidth = fieldRect.width - 40;
        const fieldHeight = fieldRect.height - 40;

        // MOBIL: Ball beveger seg vertikalt (opp/ned)
        // Reflektion fra venstre/h√∏yre vegger
        if (gameState.ballX <= 10 || gameState.ballX >= fieldWidth - 10) {
            gameState.ballVelX = -gameState.ballVelX;
            gameState.ballX = Math.max(10, Math.min(fieldWidth - 10, gameState.ballX));
            gameState.ballVelX += (Math.random() - 0.5) * 0.3;
        }

        // M√ÖL: Topp og bunn
        if (gameState.ballY <= 0) {
            goalScored('viking');
        } else if (gameState.ballY >= fieldHeight) {
            goalScored('opponent');
        }

        // BEGRENS MAKSIMAL HASTIGHET (redusert fra 7 til 5)
        const maxSpeed = 5;
        if (Math.abs(gameState.ballVelX) > maxSpeed) {
            gameState.ballVelX = gameState.ballVelX > 0 ? maxSpeed : -maxSpeed;
        }
        if (Math.abs(gameState.ballVelY) > maxSpeed) {
            gameState.ballVelY = gameState.ballVelY > 0 ? maxSpeed : -maxSpeed;
        }
        
        // Oppdater ball visuelt MED TRANSFORM
        const ball = document.getElementById('ball');
        if (ball) {
            ball.style.transform = `translate(${gameState.ballX}px, ${gameState.ballY}px)`;
        }
    }

    // FORBEDRET KOLLISJONSH√ÖNDTERING
    function checkPlayerCollisions() {
        const viking = document.getElementById('viking');
        const opponent = document.getElementById('opponent');
        const ball = document.getElementById('ball');
        
        if (!viking || !opponent || !ball) return;
        
        const ballCenterX = gameState.ballX + 7.5; // 15px ball / 2
        const ballCenterY = gameState.ballY + 7.5;
        const currentTime = Date.now();
        
        // Hindre for raske kollisjoner
        if (currentTime - gameState.lastCollisionTime < 100) return;
        
        const gameFieldRect = gameField.getBoundingClientRect();
        
        // Viking-kollisjon (nederst) - FORBEDRET
        const vikingRect = viking.getBoundingClientRect();
        const vikingTop = vikingRect.top - gameFieldRect.top;
        const vikingLeft = vikingRect.left - gameFieldRect.left;
        const vikingRight = vikingRect.right - gameFieldRect.left;
        const vikingBottom = vikingRect.bottom - gameFieldRect.top;
        
        if (ballCenterY >= (vikingTop - 10) && 
            ballCenterY <= (vikingBottom + 5) &&
            ballCenterX >= (vikingLeft - 5) && 
            ballCenterX <= (vikingRight + 5)) {
            
            gameState.lastCollisionTime = currentTime;
            
            // Mykere hastighetsendring (10% √∏kning i stedet for fast verdi)
            gameState.ballVelY = -Math.abs(gameState.ballVelY * 1.1);
            
            const hitPos = (ballCenterX - vikingLeft) / (vikingRight - vikingLeft);
            gameState.ballVelX = (hitPos - 0.5) * 6;
            
            // Jevn posisjonsjustering (ikke hopp)
            const overlap = (vikingTop - ballCenterY);
            if (overlap > 0) {
                gameState.ballY -= overlap + 5; // Gradvis flytting
            }
            
            soundSystem.playBallHit();
        }
        
        // Motstander-kollisjon (√∏verst) - FORBEDRET
        const opponentRect = opponent.getBoundingClientRect();
        const opponentTop = opponentRect.top - gameFieldRect.top;
        const opponentLeft = opponentRect.left - gameFieldRect.left;
        const opponentRight = opponentRect.right - gameFieldRect.left;
        const opponentBottom = opponentRect.bottom - gameFieldRect.top;
        
        if (ballCenterY <= (opponentBottom + 10) && 
            ballCenterY >= (opponentTop - 5) &&
            ballCenterX >= (opponentLeft - 5) && 
            ballCenterX <= (opponentRight + 5)) {
            
            gameState.lastCollisionTime = currentTime;
            
            // Mykere hastighetsendring
            gameState.ballVelY = Math.abs(gameState.ballVelY * 1.1);
            
            const hitPos = (ballCenterX - opponentLeft) / (opponentRight - opponentLeft);
            gameState.ballVelX = (hitPos - 0.5) * 5;
            
            const overlap = (ballCenterY - opponentBottom);
            if (overlap < 0) {
                gameState.ballY -= overlap - 5;
            }
            
            soundSystem.playBallHit();
        }
    }
    
    function updateOpponent() {
        if (gameState.paused) return;
        
        const currentTeam = getCurrentOpponent();
        if (!currentTeam) return;
        
        const difficulty = currentTeam.difficulty;
        const speed = 1.4 + difficulty * 0.4;
        
        // MOBIL: Motstander f√∏lger ball horisontalt
        const targetX = gameState.ballX - 40;
        const accuracy = 0.6 + difficulty * 0.1;
        const error = (Math.random() - 0.5) * (60 / accuracy);
        const adjustedTarget = targetX + error;

        if (gameState.opponentX < adjustedTarget - speed) {
            gameState.opponentX += speed;
        } else if (gameState.opponentX > adjustedTarget + speed) {
            gameState.opponentX -= speed;
        }

        const fieldWidth = gameField.offsetWidth;
        const playerWidth = 80;
        const maxX = fieldWidth - playerWidth;
        gameState.opponentX = Math.max(0, Math.min(maxX, gameState.opponentX));
        
        const opponent = document.getElementById('opponent');
        if (opponent) {
            const centerOffset = (gameState.opponentX - fieldWidth/2) + playerWidth/2;
            opponent.style.transform = `translateX(calc(-50% + ${centerOffset}px))`;
        }
    }
            
    function updateViking() {
        if (gameState.paused) return;
        
        const viking = document.getElementById('viking');
        if (viking) {
            const fieldWidth = gameField.offsetWidth;
            const playerWidth = 80;
            const centerOffset = (gameState.vikingX - fieldWidth/2) + playerWidth/2;
            
            viking.style.transform = `translateX(calc(-50% + ${centerOffset}px))`;
        }
    }

    function checkForVAR(scorer, goalScorer, team, isVikingFifthGoal = false) {
        if (Math.random() < 0.1) {
            console.log('üé• VAR-situasjon!');
            showVARCheck(scorer, goalScorer, team, isVikingFifthGoal);
            return true;
        }
        return false;
    }

    function showVARCheck(scorer, goalScorer, team, isVikingFifthGoal = false) {
    soundSystem.playVAR();
    
    showOffsideLines(scorer);
    
    setTimeout(() => {
        const varScreen = document.createElement('div');
        varScreen.className = 'var-screen';
        varScreen.id = 'varScreen';
        
        varScreen.innerHTML = `
            <img src="assets/images/var-plakat.png" style="width: 200px; height: 140px; margin-bottom: 10px;" onerror="this.style.display='none';">
            <div style="color: #FF0000; font-size: 24px; font-weight: bold; margin-bottom: 15px; font-family: 'Courier New', monospace;">
                üìπ VAR SJEKK
            </div>
            <div class="var-checking" style="font-size: 18px; font-weight: bold; margin-bottom: 20px; font-family: 'Courier New', monospace;">
                SJEKKER MULIG OFFSIDE
            </div>
            <div style="color: #FFFF00; font-size: 18px; margin-bottom: 20px;">
                VAR
            </div>
            <div style="color: #FFD700; font-size: 16px; font-family: 'Courier New', monospace;">
                ${goalScorer.name} - ${team.name.toUpperCase()}
            </div>
        `;
        
        document.body.appendChild(varScreen);
        
        // Start linje-animasjoner etter 1 sekund
        setTimeout(() => {
            animateVARLines(scorer);
        }, 1000);
        
        // Simuler VAR-sjekk i 4 sekunder
        setTimeout(() => {
            makeVARDecision(scorer, goalScorer, team, varScreen, isVikingFifthGoal);
        }, 4000);
    }, 500);
}
function showOffsideLines(scorer) {
    const gameField = document.getElementById('gameField');
    const fieldRect = gameField.getBoundingClientRect();
    
    const varLines = document.createElement('div');
    varLines.className = 'var-lines';
    varLines.id = 'varLines';
    varLines.style.width = fieldRect.width + 'px';
    varLines.style.height = fieldRect.height + 'px';
    varLines.style.left = fieldRect.left + 'px';
    varLines.style.top = fieldRect.top + 'px';
    
    // P√• mobil: m√•l er oppe/nede, s√• plasser linjer horisontalt
    const baseY = scorer === 'viking' ? 25 : 75; // 25% (oppe) eller 75% (nede)
    
    // R√∏d linje (horisontal for mobil)
    const redLine = document.createElement('div');
    redLine.className = 'offside-line red';
    redLine.id = 'redLine';
    redLine.style.width = '60%';
    redLine.style.height = '4px';
    redLine.style.left = '20%';
    redLine.style.top = baseY + '%';
    redLine.style.animation = 'varLineAppear 0.7s ease-in-out forwards';
    
    // Gr√∏nn linje (horisontal for mobil)
    const greenLine = document.createElement('div');
    greenLine.className = 'offside-line green';
    greenLine.id = 'greenLine';
    greenLine.style.width = '60%';
    greenLine.style.height = '4px';
    greenLine.style.left = '20%';
    greenLine.style.top = (baseY + 3) + '%';
    greenLine.style.animation = 'varLineAppear 0.7s ease-in-out 0.3s forwards';
    
    varLines.appendChild(redLine);
    varLines.appendChild(greenLine);
    document.body.appendChild(varLines);
}

function animateVARLines(scorer) {
    const redLine = document.getElementById('redLine');
    const greenLine = document.getElementById('greenLine');
    
    if (!redLine || !greenLine) return;
    
    let moveCount = 0;
    const maxMoves = 2 + Math.floor(Math.random() * 2);
    
    const moveInterval = setInterval(() => {
        if (moveCount >= maxMoves) {
            clearInterval(moveInterval);
            return;
        }
        
        // Flytt linjene litt opp/ned for mobil
        const redCurrentY = parseFloat(redLine.style.top);
        const greenCurrentY = parseFloat(greenLine.style.top);
        
        const redNewY = redCurrentY + (Math.random() * 4 - 2);
        const greenNewY = greenCurrentY + (Math.random() * 4 - 2);
        
        redLine.style.top = Math.max(10, Math.min(90, redNewY)) + '%';
        greenLine.style.top = Math.max(10, Math.min(90, greenNewY)) + '%';
        
        moveCount++;
    }, 800);
}

function animateFinalLines(goalStands) {
    const redLine = document.getElementById('redLine');
    const greenLine = document.getElementById('greenLine');
    
    if (!redLine || !greenLine) return;
    
    if (goalStands) {
        setTimeout(() => {
            redLine.style.backgroundColor = '#00FF00';
            redLine.style.color = '#00FF00';
            redLine.style.boxShadow = '0 0 15px #00FF00';
        }, 200);
    } else {
        setTimeout(() => {
            greenLine.style.backgroundColor = '#FF0000';
            greenLine.style.color = '#FF0000';
            greenLine.style.boxShadow = '0 0 15px #FF0000';
        }, 200);
    }
}

function cleanupVAR() {
    const varScreen = document.getElementById('varScreen');
    const varLines = document.getElementById('varLines');
    
    if (varScreen) {
        try {
            document.body.removeChild(varScreen);
        } catch (e) {
            console.log('VAR-skjerm allerede fjernet');
        }
    }
    
    if (varLines) {
        try {
            document.body.removeChild(varLines);
        } catch (e) {
            console.log('VAR-linjer allerede fjernet');
        }
    }
    soundSystem.stopAllGoalSounds();
}
    function makeVARDecision(scorer, goalScorer, team, varScreen, isVikingFifthGoal = false) {
        const goalStands = Math.random() < 0.5;
        const currentMatch = vikingSchedule[gameState.currentMatchIndex];
        
        if (goalStands) {
            // M√ÖL GODKJENT
            if (scorer === 'viking') {
                soundSystem.playScoring();
                if (isVikingFifthGoal) {
                    setTimeout(() => {
                        soundSystem.playViking5Goals();
                    }, 4000);
                }
            }
            
            updateUI();
            
            let scoreDisplay;
            if (currentMatch && currentMatch.home) {
                scoreDisplay = `VIKING FK ${gameState.vikingScore} ‚Äì ${gameState.opponentScore} ${getCurrentOpponent()?.name?.toUpperCase() || 'MOTSTANDER'}`;
            } else {
                scoreDisplay = `${getCurrentOpponent()?.name?.toUpperCase() || 'MOTSTANDER'} ${gameState.opponentScore} ‚Äì ${gameState.vikingScore} VIKING FK`;
            }
            
            varScreen.innerHTML = `
                <div style="color: #00FF00; font-size: 28px; font-weight: bold; margin-bottom: 15px; font-family: 'Courier New', monospace;">
                    M√ÖL GODKJENT
                </div>
                <div style="color: #00FF00; font-size: 16px; margin-bottom: 15px;">
                    Ingen overtredelse funnet
                </div>
                <div style="color: #FFD700; font-size: 16px; font-family: 'Courier New', monospace;">
                    ${goalScorer.name} - ${team.name.toUpperCase()}
                </div>
                <div style="color: #00FF00; font-size: 18px; font-weight: bold; margin-top: 15px; font-family: 'Courier New', monospace;">
                    ${scoreDisplay}
                </div>
            `;
            varScreen.style.borderColor = '#00FF00';
            varScreen.style.boxShadow = '0 0 50px rgba(0,255,0,0.5)';
            
            setTimeout(() => {
                cleanupVAR();
                setTimeout(() => {
                    showGoalScorerDisplay(goalScorer, team);
                    setTimeout(() => {
                        if (!gameState.halfTimeBreak && gameState.matchTime < 90) {
                            kickOff(scorer === 'viking' ? 'opponent' : 'viking');
                            gameState.gameActive = true;
                        }
                    }, 4000);
                }, 500);
            }, 3000);
            
        } else {
            // M√ÖL ANNULLERT
            if (scorer === 'viking') {
                gameState.vikingScore--;
            } else {
                gameState.opponentScore--;
            }
            
            updateUI();
            
            let scoreDisplay;
            if (currentMatch && currentMatch.home) {
                scoreDisplay = `VIKING FK ${gameState.vikingScore} ‚Äì ${gameState.opponentScore} ${getCurrentOpponent()?.name?.toUpperCase() || 'MOTSTANDER'}`;
            } else {
                scoreDisplay = `${getCurrentOpponent()?.name?.toUpperCase() || 'MOTSTANDER'} ${gameState.opponentScore} ‚Äì ${gameState.vikingScore} VIKING FK`;
            }
            
            varScreen.innerHTML = `
                <div style="color: #FF0000; font-size: 28px; font-weight: bold; margin-bottom: 15px; font-family: 'Courier New', monospace;">
                    M√ÖL ANNULLERT
                </div>
                <div style="color: #FF0000; font-size: 16px; margin-bottom: 15px;">
                    Offside p√• angrepsspiller
                </div>
                <div style="color: #FFD700; font-size: 16px; font-family: 'Courier New', monospace;">
                    ${goalScorer.name} - ${team.name.toUpperCase()}
                </div>
                <div style="color: #FF6B6B; font-size: 18px; font-weight: bold; margin-top: 15px; font-family: 'Courier New', monospace;">
                    ${scoreDisplay}
                </div>
            `;
            
            setTimeout(() => {
                cleanupVAR();
                setTimeout(() => {
                    if (!gameState.halfTimeBreak && gameState.matchTime < 90) {
                        kickOff(scorer === 'viking' ? 'opponent' : 'viking');
                        gameState.gameActive = true;
                    }
                }, 500);
            }, 3000);
        }
    }

    function cleanupVAR() {
        const varScreen = document.getElementById('varScreen');
        if (varScreen) {
            try {
                document.body.removeChild(varScreen);
            } catch (e) {
                console.log('VAR-skjerm allerede fjernet');
            }
        }
        soundSystem.stopAllGoalSounds();
    }

    function showGoalScorerDisplay(player, team) {
        const scorerDisplay = document.createElement('div');
        const isViking = team.name === 'Viking FK';
        scorerDisplay.className = isViking ? 'goal-scorer-display viking' : 'goal-scorer-display';
        
        const displayId = 'goalScorer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        scorerDisplay.id = displayId;

        const playerImage = `assets/players/${team.name.toLowerCase().replace(/\s+/g, '-').replace('√∏','o').replace('√•','a')}/${player.image}.png`;

        scorerDisplay.innerHTML = `
                    <div style="width: 200px; height: 200px; border-radius: 50%; border: 4px solid #FFD700; margin: 0 auto 20px auto; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #FFD700, #FFA500); position: relative; overflow: hidden; box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);">
                        <img src="${playerImage}" alt="${player.name}" style="width: 190px; height: 190px; object-fit: contain; border-radius: 50%;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; font-size: 65px; color: #000;">${player.emoji}</div>
                    </div>
                    <div class="goal-scorer-name">‚öΩ M√ÖL!</div>
                    <div class="goal-scorer-team">${player.name}</div>
                    <div style="color: #FFFFFF; font-size: 14px; margin-top: 8px;">${team.name.toUpperCase()}</div>
                    <div style="color: #00FF00; font-size: 18px; font-weight: bold; margin-top: 10px; font-family: 'Courier New', monospace;">
                        VIKING FK ${gameState.vikingScore} ‚Äì ${gameState.opponentScore} ${getCurrentOpponent().name.toUpperCase()}
                    </div>
                `;
        
        document.body.appendChild(scorerDisplay);

        setTimeout(() => {
            const elementToRemove = document.getElementById(displayId);
            if (elementToRemove) {
                try {
                    document.body.removeChild(elementToRemove);
                } catch (e) {
                    console.log('M√•lscorer-display allerede fjernet');
                }
            }
        }, 4000);
    }

    
    function updateUI() {
        const homeTeamName = document.getElementById('homeTeamName');
        const awayTeamName = document.getElementById('awayTeamName');
        const homeScore = document.getElementById('homeScore');
        const awayScore = document.getElementById('awayScore');
        const leftLogo = document.getElementById('leftLogo');
        const rightLogo = document.getElementById('rightLogo');
        
        if (gameState.currentMatchIndex >= vikingSchedule.length) {
            if (homeTeamName) homeTeamName.textContent = 'SESONGEN';
            if (awayTeamName) awayTeamName.textContent = 'FERDIG';
            if (homeScore) homeScore.textContent = '';
            if (awayScore) awayScore.textContent = '';
            return;
        }
        
        const currentMatch = vikingSchedule[gameState.currentMatchIndex];
        const opponentTeam = getCurrentOpponent();
        
        if (currentMatch.type === 'cup' && gameState.cupEliminated) {
            gameState.currentMatchIndex++;
            updateUI();
            return;
        }
        
        if (opponentTeam && currentMatch && homeTeamName && awayTeamName) {
            gameState.currentOpponentTeam = opponentTeam;
            
            // LOGOER - alltid Viking til venstre p√• mobil
            if (leftLogo) {
                leftLogo.src = 'assets/teams/viking-fk.png';
                leftLogo.style.display = 'block';
            }
            if (rightLogo) {
                rightLogo.src = getTeamLogoPath(opponentTeam.name);
                rightLogo.style.display = 'block';
            }
            
            // SCOREBOARD basert p√• hjemme/borte
            if (currentMatch.home) {
                homeTeamName.textContent = 'VIKING FK';
                awayTeamName.textContent = opponentTeam.name.toUpperCase();
                if (homeScore) homeScore.textContent = gameState.vikingScore;
                if (awayScore) awayScore.textContent = gameState.opponentScore;
            } else {
                homeTeamName.textContent = opponentTeam.name.toUpperCase();
                awayTeamName.textContent = 'VIKING FK';
                if (homeScore) homeScore.textContent = gameState.opponentScore;
                if (awayScore) awayScore.textContent = gameState.vikingScore;
            }
        }
    }
    
    function updateMatchClock() {
        if (!gameState.gameActive || gameState.paused || gameState.halfTimeBreak) return;
        
        if (!gameState.matchStartTime) {
            gameState.matchStartTime = Date.now();
            gameState.matchTime = 0;
        }
        
        const elapsed = Date.now() - gameState.matchStartTime;
        const halfDuration = gameState.matchDuration;
        
        if (gameState.currentHalf === 1) {
            gameState.matchTime = Math.floor((elapsed / halfDuration) * 45);
            if (gameState.matchTime >= 45) {
                gameState.matchTime = 45;
                showHalfTimeBreak();
            }
        } else {
            gameState.matchTime = 45 + Math.floor((elapsed / halfDuration) * 45);
            if (gameState.matchTime >= 90) {
                gameState.matchTime = 90;
                endMatch();
            }
        }
        
        updateClockDisplay();
    }

    function updateClockDisplay() {
        const clockElement = document.getElementById('matchClock');
        if (clockElement) {
            clockElement.textContent = `${gameState.matchTime}'`;
        }
    }

    function showHalfTimeBreak() {
        cleanupVAR();
        gameState.gameActive = false;
        gameState.halfTimeBreak = true;
        
        let secondHalfStarted = false;
        
        const halfTimeScreen = document.createElement('div');
        halfTimeScreen.className = 'halftime-screen';
        halfTimeScreen.id = 'halfTimeScreen';
        halfTimeScreen.innerHTML = `
            <h2 style="color: #FFD700; margin-bottom: 20px; font-family: 'Courier New', monospace;">‚è±Ô∏è PAUSE ‚è±Ô∏è</h2>
            <div style="color: #00FF00; font-size: 24px; font-weight: bold; margin-bottom: 15px; font-family: 'Courier New', monospace;">
                1. OMGANG FERDIG
            </div>
            <div style="color: #FFFFFF; font-size: 20px; margin-bottom: 20px; font-family: 'Courier New', monospace;">
                VIKING FK ${gameState.vikingScore} ‚Äì ${gameState.opponentScore} ${getCurrentOpponent().name.toUpperCase()}
            </div>
            <div style="color: #FFD700; font-size: 14px; margin-bottom: 25px;">
                Forbereder 2. omgang
            </div>
            <button class="button" onclick="startSecondHalfOnce()" style="background: linear-gradient(135deg, #00AA00, #00FF00); color: #000;">
                Start 2. omgang
            </button>
        `;
        
        document.body.appendChild(halfTimeScreen);
        
        window.startSecondHalfOnce = function() {
            if (!secondHalfStarted) {
                secondHalfStarted = true;
                startSecondHalf();
            }
        };
        
        setTimeout(() => {
            if (!secondHalfStarted) {
                secondHalfStarted = true;
                startSecondHalf();
            }
        }, 3000);
    }

    function endMatch() {
        if (gameState.currentHalf < 2 || gameState.matchTime < 45) {
            return;
        }
        
        gameState.gameActive = false;
        const currentTeam = getCurrentOpponent();
        const currentMatch = vikingSchedule[gameState.currentMatchIndex];

        if (currentMatch.type === 'serie') {
            vikingTeam.goalsFor += gameState.vikingScore;
            vikingTeam.goalsAgainst += gameState.opponentScore;
            currentTeam.goalsFor += gameState.opponentScore;
            currentTeam.goalsAgainst += gameState.vikingScore;
            
            if (gameState.vikingScore > gameState.opponentScore) {
                vikingTeam.won++;
                vikingTeam.points += 3;
                currentTeam.lost++;
            } else if (gameState.opponentScore > gameState.vikingScore) {
                vikingTeam.lost++;
                currentTeam.won++;
                currentTeam.points += 3;
            } else {
                vikingTeam.draws++;
                vikingTeam.points += 1;
                currentTeam.draws++;
                currentTeam.points += 1;
            }
            
            vikingTeam.played++;
            currentTeam.played++;
        }

        if (currentMatch && currentMatch.type === 'cup') {
            if (gameState.vikingScore < gameState.opponentScore) {
                gameState.cupEliminated = true;
            } else if (gameState.vikingScore === gameState.opponentScore) {
                if (Math.random() < 0.5) {
                    gameState.cupEliminated = true;
                    displayMessage('TYPISK! TAPTE P√Ö STRAFFEKONK!', 3000);
                } else {
                    displayMessage('JADDA! VANT STRAFFEKONK!', 3000);
                }
            }
            if (!gameState.cupEliminated) {
                updateNextCupOpponent(currentMatch.round);
            }
        }

        setTimeout(() => {
            showRoundSummary();
        }, 1500);
    }

    function gameLoop() {
        if (gameState.gameActive && !gameState.paused) {
            updateBall();
            updateOpponent();
            updateViking();
            updateMatchClock();
        }
        requestAnimationFrame(gameLoop);
    }

    // Touch kontroller
    if (touchArea) {
        touchArea.addEventListener('touchstart', handleTouch, {passive: false});
        touchArea.addEventListener('touchmove', handleTouch, {passive: false});
        touchArea.addEventListener('touchend', handleTouch, {passive: false});
    }

    function handleTouch(e) {
        e.preventDefault();
        if (e.touches.length > 0) {
            const touch = e.touches[0];
            const relativeX = touch.clientX / window.innerWidth;
            
            const fieldWidth = gameField.offsetWidth;
            const playerWidth = 80;
            const maxX = fieldWidth - playerWidth;
            
            // SMOOTHING for mindre f√∏lsomhet
            const targetX = relativeX * fieldWidth;
            const smoothing = 0.3;
            gameState.vikingX = gameState.vikingX + (targetX - gameState.vikingX) * smoothing;
            
            gameState.vikingX = Math.max(0, Math.min(maxX, gameState.vikingX));
        }
    }

    // Start spillet
    updateUI();
    updateOpponentJersey();
    showCountdown(() => {
        kickOff('viking');
        gameState.gameActive = true;
    }, "1. OMGANG");
    gameLoop();
    
    // Gj√∏r funksjoner globalt tilgjengelige
    window.kickOff = kickOff;
    window.updateUI = updateUI;
    window.updateOpponentJersey = updateOpponentJersey;
    window.showCountdown = showCountdown;
    window.goalScored = goalScored;
}

// ===== HJELPEFUNKSJONER =====
function displayMessage(text, duration = 2500) {
    const tempMessage = document.createElement('div');
    tempMessage.style.position = 'fixed';
    tempMessage.style.top = '40%';
    tempMessage.style.left = '50%';
    tempMessage.style.transform = 'translate(-50%, -50%)';
    tempMessage.style.background = 'linear-gradient(135deg, #000000, #1a1a1a)';
    tempMessage.style.color = '#00FF00';
    tempMessage.style.padding = '20px 30px';
    tempMessage.style.borderRadius = '15px';
    tempMessage.style.fontSize = '20px';
    tempMessage.style.zIndex = '300';
    tempMessage.style.border = '2px solid #00FF00';
    tempMessage.style.fontWeight = 'bold';
    tempMessage.style.textAlign = 'center';
    tempMessage.style.fontFamily = "'Courier New', monospace";
    tempMessage.style.textShadow = '0 0 10px #00FF00';
    tempMessage.style.backdropFilter = 'blur(10px)';
    tempMessage.textContent = text;

    document.body.appendChild(tempMessage);

    setTimeout(() => {
        if (tempMessage.parentNode) {
            tempMessage.parentNode.removeChild(tempMessage);
        }
    }, duration);
}

function resetBallCompletely() {
    gameState.ballVelX = 0;
    gameState.ballVelY = 0;
    gameState.ballX = 300;
    gameState.ballY = 350;
    
    const ball = document.getElementById('ball');
    if (ball) {
        ball.style.transform = `translate(${gameState.ballX}px, ${gameState.ballY}px)`;
    }
}

function getTeamLogoPath(teamName) {
    if (teamName === 'Molde FK' || teamName === 'Molde') {
        return 'assets/teams/molde-fk.jpg';
    }
    
    const team = findTeamByName(teamName);
    if (team && team.logo) {
        return `assets/teams/${team.logo}`;
    }
    
    const cupLogos = {
        'Hana': 'hana-il.png',
        'Hana IL': 'hana-il.png',
        'Fl√∏y-Flekker√∏y': 'floy-flekkeroy.png',
        'Moss': 'moss-fk.png',
        'Moss FK': 'moss-fk.png',
        '√Ösane': 'asane-fotball.png',
        '√Ösane Fotball': 'asane-fotball.png',
        'Aalesund': 'aalesund.png'
    };
    
    if (cupLogos[teamName]) {
        return `assets/teams/${cupLogos[teamName]}`;
    }
    
    const logoName = teamName
        .toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/√∏/g, 'o')
        .replace(/√•/g, 'a') 
        .replace(/√¶/g, 'ae')
        .replace(/\//g, '-')
        .replace(/[^\w\-]/g, '')
        .replace(/--+/g, '-')
        .replace(/^-|-$/g, '');
    
    return `assets/teams/${logoName}.png`;
}

// ===== RUNDEOVERSIKT FUNKSJONER =====
function showRoundSummary() {
    const currentMatch = vikingSchedule[gameState.currentMatchIndex];
    
    if (currentMatch && currentMatch.type === 'cup') {
        addCupGoalsForCompletedRound(currentMatch.round);
        const cupResults = generateCupResults(currentMatch.round);
        gameState.roundResults = cupResults;
    } else {
        const otherResults = generateOtherResults();
        gameState.roundResults = otherResults;
    }

    gameState.summaryPage = 1;
    showSummaryPage(1);
}

function showSummaryPage(pageNumber) {
    const roundSummary = document.getElementById('roundSummary');
    const roundSummaryContent = document.getElementById('roundSummaryContent');
    
    let content = '';
    const currentMatch = vikingSchedule[gameState.currentMatchIndex];
    const isCup = currentMatch && currentMatch.type === 'cup';

    if (pageNumber === 1) {
        content = `
            <div style="display: flex; flex-direction: column; height: calc(100vh - 120px); max-width: 900px; margin: 0 auto; padding-top: 70px;">
                <div style="flex: 1; background: linear-gradient(135deg, #1a1a1a, #2a2a2a); padding: 20px; border-radius: 15px; border: 2px solid ${isCup ? '#FF6B6B' : '#FFD700'}; overflow: hidden;">
                    ${generateAllMatchesHTML()}
                </div>
            </div>
        `;
    } else if (pageNumber === 2) {
        content = `
            <div style="display: flex; flex-direction: column; height: calc(100vh - 120px); max-width: 900px; margin: 0 auto; padding-top: 70px;">
                <div style="flex: 1; background: linear-gradient(135deg, #1a1a1a, #2a2a2a); padding: 20px; border-radius: 15px; border: 2px solid ${isCup ? '#FF6B6B' : '#FFD700'}; overflow: hidden;">
                    ${isCup ? generateCupTopScorersHTML() : generateTopScorersWithImagesHTML()}
                </div>
            </div>
        `;
    } else if (pageNumber === 3) {
        content = `
            <div style="display: flex; flex-direction: column; height: calc(100vh - 120px); max-width: 900px; margin: 0 auto; padding-top: 70px;">
                <div style="flex: 1; background: linear-gradient(135deg, #1a1a1a, #2a2a2a); padding: 20px; border-radius: 15px; border: 2px solid ${isCup ? '#FF6B6B' : '#FFD700'}; overflow: hidden;">
                    ${isCup ? generateCupDrawHTML(currentMatch.round) : generateCompactLeagueTableHTML()}
                </div>
            </div>
        `;
    }
    
    roundSummaryContent.innerHTML = content;
    roundSummary.style.display = 'block';
    
    const existingButtons = roundSummary.querySelectorAll('.summary-nav-btn, .summary-main-btn, .summary-title');
    existingButtons.forEach(btn => {
        if (btn.parentNode) {
            btn.parentNode.removeChild(btn);
        }
    });
    
    addFullscreenElements(pageNumber, isCup);
}

function addFullscreenElements(pageNumber, isCup = false) {
    const roundSummary = document.getElementById('roundSummary');
    
    const title = document.createElement('div');
    title.className = 'summary-title';
    title.style.cssText = `
        position: fixed !important;
        top: 20px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        background: linear-gradient(135deg, #000000, #1a1a1a);
        color: ${isCup ? '#FF6B6B' : '#FFD700'};
        padding: 10px 30px;
        border-radius: 15px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 14px;
        border: 2px solid ${isCup ? '#FF6B6B' : '#FFD700'};
        z-index: 250;
        backdrop-filter: blur(10px);
        box-shadow: 0 0 20px rgba(${isCup ? '255,107,107' : '255,215,0'},0.3);
        max-width: 70vw;
        text-align: center;
    `;
    
    if (pageNumber === 1) {
        const currentMatch = vikingSchedule[gameState.currentMatchIndex];
        if (isCup) {
            title.textContent = `üèÜ CUP ${cupData.roundNames[currentMatch.round]} - RESULTATER`;
        } else {
            title.textContent = `‚öΩ RUNDE ${gameState.currentRound} - RESULTATER`;
        }
    } else if (pageNumber === 2) {
        title.textContent = isCup ? 'üèÜ CUP-TOPPSCORERE' : '‚öΩ TOPPSCORERE';
    } else if (pageNumber === 3) {
        title.textContent = isCup ? 'üèÜ NESTE CUP-RUNDE' : '‚öΩ ELITESERIEN';
    }
   
    roundSummary.appendChild(title);
    
    if (pageNumber === 1) {
        const nextBtn = createNavButton('Neste ‚Üí', 'showSummaryPage(2)', 'right', '#4A90E2', '#357ABD');
        roundSummary.appendChild(nextBtn);
    } else if (pageNumber === 2) {
        const prevBtn = createNavButton('‚Üê Forrige', 'showSummaryPage(1)', 'left', '#666', '#888');
        const nextBtn = createNavButton('Neste ‚Üí', 'showSummaryPage(3)', 'right', '#4A90E2', '#357ABD');
        roundSummary.appendChild(prevBtn);
        roundSummary.appendChild(nextBtn);
    } else if (pageNumber === 3) {
        const prevBtn = createNavButton('‚Üê Forrige', 'showSummaryPage(2)', 'left', '#666', '#888');
        const mainBtn = createMainNavButton();
        roundSummary.appendChild(prevBtn);
        roundSummary.appendChild(mainBtn);
    }
}

function createNavButton(text, onclick, side, color1, color2) {
    const btn = document.createElement('button');
    btn.className = 'summary-nav-btn';
    btn.onclick = new Function(onclick);
    btn.textContent = text;
    btn.style.cssText = `
        position: fixed !important;
        ${side}: 15px !important;
        bottom: 80px !important;
        background: linear-gradient(135deg, ${color1}, ${color2}) !important;
        font-size: 14px !important;
        padding: 12px 20px !important;
        border-radius: 25px !important;
        box-shadow: 0 0 20px rgba(${side === 'right' ? '74, 144, 226' : '102, 102, 102'}, 0.6) !important;
        border: 2px solid #FFD700 !important;
        z-index: 250 !important;
        color: white !important;
        font-weight: bold !important;
        cursor: pointer !important;
        backdrop-filter: blur(10px) !important;
        max-width: 35vw !important;
        text-align: center !important;
    `;
    return btn;
}

function createMainNavButton() {
    const btn = document.createElement('button');
    btn.className = 'summary-main-btn';
    
    const isSeasonEnd = gameState.currentMatchIndex >= vikingSchedule.length;
    
    btn.onclick = isSeasonEnd ? window.restartSeason : continueToNextRound;
    
    const nextMatch = vikingSchedule[gameState.currentMatchIndex + 1];
    const isCupMatch = nextMatch && nextMatch.type === 'cup';
    
    btn.style.cssText = `
        position: fixed !important;
        right: 15px !important;
        bottom: 80px !important;
        background: ${isCupMatch ? 
            'linear-gradient(135deg, #FFD700, #FFA500)' : 
            isSeasonEnd ? 'linear-gradient(135deg, #FF6B6B, #FF4444)' : 
            'linear-gradient(135deg, #00AA00, #00FF00)'} !important;
        color: ${isCupMatch || isSeasonEnd ? '#000' : '#000'} !important;
        font-size: 14px !important;
        padding: 12px 20px !important;
        border-radius: 25px !important;
        box-shadow: 0 0 25px rgba(${isCupMatch ? '255, 215, 0' : 
            isSeasonEnd ? '255, 107, 107' : '0, 255, 0'}, 0.8) !important;
        border: 2px solid ${isCupMatch ? '#FFA500' : '#FFD700'} !important;
        z-index: 250 !important;
        font-weight: bold !important;
        cursor: pointer !important;
        backdrop-filter: blur(10px) !important;
        max-width: 40vw !important;
        text-align: center !important;
    `;
    
    if (isSeasonEnd) {
        btn.innerHTML = 'Ny sesong';
    } else if (nextMatch) {
        if (isCupMatch) {
            const roundName = cupData.roundNames[nextMatch.round] || 'CUP';
            btn.innerHTML = `üèÜ ${roundName}`;
        } else {
            btn.innerHTML = `Neste kamp`;
        }
    }
    
    return btn;
}

function generateAllMatchesHTML() {
    const currentTeam = getCurrentOpponent();
    const vikingWon = gameState.vikingScore > gameState.opponentScore;
    const isDraw = gameState.vikingScore === gameState.opponentScore;
    
    let html = '';
    
    const vikingLogo = getTeamLogoPath('Viking FK');
    const opponentLogo = currentTeam ? getTeamLogoPath(currentTeam.name) : '';
    
    html += `
        <div style="display: flex; align-items: center; gap: 15px; padding: 10px 0; border-bottom: 2px solid ${isDraw ? '#FFD700' : (vikingWon ? '#00FF00' : '#FF6B6B')}; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 8px; flex: 1; justify-content: flex-end;">
                <div style="color: #FFD700; font-family: 'Courier New', monospace; font-size: 13px; text-align: right; font-weight: bold;">VIKING FK</div>
                <img src="${vikingLogo}" style="width: 28px; height: 28px; object-fit: contain; flex-shrink: 0;" onerror="this.style.display='none';">
            </div>
            <div style="color: ${isDraw ? '#FFD700' : (vikingWon ? '#00FF00' : '#FF6B6B')}; font-weight: bold; text-align: center; min-width: 65px; background: rgba(${isDraw ? '255,215,0' : (vikingWon ? '0,255,0' : '255,107,107')},0.1); padding: 6px 10px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 16px; border: 1px solid ${isDraw ? '#FFD700' : (vikingWon ? '#00FF00' : '#FF6B6B')};">
                ${gameState.vikingScore} - ${gameState.opponentScore}
            </div>
            <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                <img src="${opponentLogo}" style="width: 28px; height: 28px; object-fit: contain; flex-shrink: 0;" onerror="this.style.display='none';">
                <div style="color: white; font-family: 'Courier New', monospace; font-size: 13px; font-weight: bold;">${currentTeam ? currentTeam.name.toUpperCase() : 'MOTSTANDER'}</div>
            </div>
        </div>
    `;
    
    if (gameState.roundResults && gameState.roundResults.length > 0) {
        gameState.roundResults.forEach(result => {
            const team1Logo = getTeamLogoPath(result.team1);
            const team2Logo = getTeamLogoPath(result.team2);
            
            html += `
                <div style="display: flex; align-items: center; gap: 15px; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; align-items: center; gap: 8px; flex: 1; justify-content: flex-end;">
                        <div style="color: white; font-family: 'Courier New', monospace; font-size: 12px; text-align: right;">${result.team1}</div>
                        <img src="${team1Logo}" style="width: 24px; height: 24px; object-fit: contain; flex-shrink: 0;" onerror="this.style.display='none';">
                    </div>
                    <div style="color: #00FF00; font-weight: bold; text-align: center; min-width: 55px; background: rgba(0,255,0,0.1); padding: 4px 8px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px;">
                        ${result.team1Goals} - ${result.team2Goals}
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                        <img src="${team2Logo}" style="width: 24px; height: 24px; object-fit: contain; flex-shrink: 0;" onerror="this.style.display='none';">
                        <div style="color: white; font-family: 'Courier New', monospace; font-size: 12px;">${result.team2}</div>
                    </div>
                </div>
            `;
        });
    }
    
    return html;
}

function generateTopScorersWithImagesHTML() {
    if (!gameState.topScorers || gameState.topScorers.length === 0) {
        return '<div style="text-align: center; color: #888; font-style: italic; font-size: 18px; margin-top: 100px;">Ingen m√•l enn√•</div>';
    }

    let html = '';
    gameState.topScorers.slice(0, 10).forEach((scorer, index) => {
        const isViking = scorer.team === 'Viking FK';

        html += `
            <div style="display: flex; align-items: center; gap: 10px; padding: 5px 15px; border-bottom: 1px solid rgba(0,255,0,0.2); margin: 0 auto; max-width: 700px;">
                <div style="color: #FFD700; font-weight: bold; min-width: 25px; text-align: center; font-family: 'Courier New', monospace; font-size: 14px;">
                    ${index + 1}
                </div>
                <div style="width: 30px; height: 30px; border-radius: 50%; overflow: hidden; border: 2px solid ${isViking ? '#FFD700' : '#00FF00'}; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #333; font-size: 12px;">
                    ${scorer.emoji}
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="color: ${isViking ? '#FFD700' : 'white'}; font-weight: ${isViking ? 'bold' : 'normal'}; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${scorer.name}
                    </div>
                    <div style="color: #888; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${scorer.team}
                    </div>
                </div>
                <div style="color: #00FF00; font-weight: bold; font-family: 'Courier New', monospace; font-size: 15px; min-width: 35px; text-align: center;">
                    ${scorer.goals}
                </div>
            </div>
        `;
    });
    return html;
}

function generateCupTopScorersHTML() {
    if (!cupTopScorers || cupTopScorers.length === 0) {
        return '<div style="text-align: center; color: #888; font-style: italic; font-size: 18px; margin-top: 100px;">Ingen cup-m√•l enn√•</div>';
    }

    let html = '';
    cupTopScorers.slice(0, 10).forEach((scorer, index) => {
        const isViking = scorer.team === 'Viking FK';

        html += `
            <div style="display: flex; align-items: center; gap: 10px; padding: 5px 15px; border-bottom: 1px solid rgba(255,107,107,0.2); margin: 0 auto; max-width: 700px;">
                <div style="color: #FF6B6B; font-weight: bold; min-width: 25px; text-align: center; font-family: 'Courier New', monospace; font-size: 14px;">
                    ${index + 1}
                </div>
                <div style="width: 30px; height: 30px; border-radius: 50%; overflow: hidden; border: 2px solid ${isViking ? '#FFD700' : '#FF6B6B'}; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #333; font-size: 12px;">
                    ${scorer.emoji}
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="color: ${isViking ? '#FFD700' : 'white'}; font-weight: ${isViking ? 'bold' : 'normal'}; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${scorer.name}
                    </div>
                    <div style="color: #888; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${scorer.team}
                    </div>
                </div>
                <div style="color: #FF6B6B; font-weight: bold; font-family: 'Courier New', monospace; font-size: 15px; min-width: 35px; text-align: center;">
                    ${scorer.goals}
                </div>
            </div>
        `;
    });
    return html;
}

function generateCompactLeagueTableHTML() {
    const serieLag = teams.filter(team => team.isSerieTeam === true);
    const allTeams = [vikingTeam, ...serieLag];
    
    allTeams.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        const aGoalDiff = a.goalsFor - a.goalsAgainst;
        const bGoalDiff = b.goalsFor - b.goalsAgainst;
        if (bGoalDiff !== aGoalDiff) return bGoalDiff - aGoalDiff;
        return b.goalsFor - a.goalsFor;
    });

    let tableHTML = `<div style="display: grid; grid-template-columns: 25px 30px 3fr 25px 25px 25px 25px 45px 30px; gap: 4px; font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 6px; font-weight: bold; color: #00FF00; border-bottom: 2px solid #00FF00; padding-bottom: 4px; max-width: 600px; margin-left: auto; margin-right: auto;">`;
    tableHTML += `<div style="text-align: center;">#</div><div></div><div>LAG</div><div>K</div><div>S</div><div>U</div><div>T</div><div>M√ÖL</div><div>P</div></div>`;

    allTeams.forEach((team, index) => {
        const isViking = team.name === 'Viking FK';
        const teamLogo = getTeamLogoPath(team.name);
        
        tableHTML += `<div style="display: grid; grid-template-columns: 25px 30px 3fr 25px 25px 25px 25px 45px 30px; gap: 4px; font-family: 'Courier New', monospace; font-size: 9px; padding: 2px 0; border-bottom: 1px solid rgba(0,255,0,0.1); color: ${isViking ? '#FFD700' : 'white'}; font-weight: ${isViking ? 'bold' : 'normal'}; max-width: 600px; margin-left: auto; margin-right: auto;">`;
        tableHTML += `<div style="text-align: center; color: #FFD700; font-weight: bold; font-size: 10px;">${index + 1}</div>`;
        tableHTML += `<div><img src="${teamLogo}" style="width: 20px; height: 20px; object-fit: contain;" onerror="this.style.display='none';"></div>`;
        tableHTML += `<div style="overflow: hidden; text-overflow: ellipsis; font-size: 10px;">${team.name}</div>`;
        tableHTML += `<div style="text-align: center; color: #00FF00; font-size: 10px;">${team.played}</div>`;
        tableHTML += `<div style="text-align: center; color: #00FF00; font-size: 9px;">${team.won}</div>`;
        tableHTML += `<div style="text-align: center; color: #00FF00; font-size: 9px;">${team.draws || 0}</div>`;
        tableHTML += `<div style="text-align: center; color: #00FF00; font-size: 9px;">${team.lost}</div>`;
        tableHTML += `<div style="text-align: center; color: #00FF00; font-size: 8px;">${team.goalsFor}-${team.goalsAgainst}</div>`;
        tableHTML += `<div style="text-align: center; color: #00FF00; font-weight: bold; font-size: 10px;">${team.points}</div>`;
        tableHTML += `</div>`;
    });

    return tableHTML;
}

function generateCupDrawHTML(currentRound) {
    const nextRound = parseInt(currentRound) + 1;
    
    if (nextRound > 7) {
        setTimeout(() => {
            soundSystem.playAnthem();
        }, 500);
        return `
            <div style="text-align: center; margin: 50px 0;">
                <div style="font-size: 80px; margin-bottom: 20px;">üëë</div>
                <h1 style="color: #FFD700; font-size: 32px; font-weight: bold; margin-bottom: 30px; font-family: 'Courier New', monospace; text-shadow: 0 0 20px #FFD700;">
                    üèÜ CUPMESTER 2025 üèÜ
                </h1>
                <div style="color: #002166; background: linear-gradient(135deg, #FFD700, #FFA500); padding: 15px 40px; border-radius: 20px; font-size: 24px; font-weight: bold; margin-bottom: 40px; border: 4px solid #FFD700; box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);">
                    VIKING FK
                </div>
                <div style="color: #00FF00; font-size: 18px; font-weight: bold; margin-top: 20px; font-family: 'Courier New', monospace; text-shadow: 0 0 10px #00FF00;">
                    ‚ö° EUROPA LEAGUE TIL STAVANGER! ‚ö°
                </div>
            </div>
        `;
    }
    
    const roundNames = {
        2: '2. RUNDE',
        3: '3. RUNDE', 
        4: '4. RUNDE',
        5: 'KVARTFINALE',
        6: 'SEMIFINALE',
        7: 'FINALE'
    };
    
    let html = `
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: #FF6B6B; font-family: 'Courier New', monospace; font-size: 20px; margin-bottom: 20px;">
                üèÜ ${roundNames[nextRound] || 'NESTE RUNDE'}
            </h2>
        </div>
    `;
    
    const vikingNextCupMatch = vikingSchedule.find(m => m.type === 'cup' && m.round === nextRound);
    
    if (vikingNextCupMatch) {
        html += `
            <div style="margin-bottom: 30px; text-align: center;">
                <h3 style="color: #FFD700; margin-bottom: 15px;">‚öΩ VIKING FK sin neste cupkamp:</h3>
                <div style="background: rgba(255,215,0,0.1); border: 2px solid #FFD700; border-radius: 10px; padding: 20px; max-width: 300px; margin: 0 auto;">
                    <div style="color: #FFD700; font-size: 16px; font-weight: bold;">
                        VIKING FK vs ${vikingNextCupMatch.opponent.toUpperCase()}
                    </div>
                    <div style="color: white; font-size: 14px; margin-top: 5px;">
                        ${vikingNextCupMatch.home ? 'Hjemme' : 'Borte'}
                    </div>
                </div>
            </div>
        `;
    }
    
    return html;
}

function addCupGoalsForCompletedRound(roundNumber) {
    const roundMatches = cupData.otherResults[roundNumber] || [];
    
    roundMatches.forEach(match => {
        const [homeGoals, awayGoals] = match.result;
        
        if (homeGoals > 0) {
            const homeTeam = findTeamByName(match.home);
            if (homeTeam) {
                for (let i = 0; i < homeGoals; i++) {
                    const scorer = getRandomPlayer(homeTeam);
                    if (scorer) addToCupTopScorers(scorer, homeTeam);
                }
            }
        }
        
        if (awayGoals > 0) {
            const awayTeam = findTeamByName(match.away);
            if (awayTeam) {
                for (let i = 0; i < awayGoals; i++) {
                    const scorer = getRandomPlayer(awayTeam);
                    if (scorer) addToCupTopScorers(scorer, awayTeam);
                }
            }
        }
    });
    
    cupTopScorers.sort((a, b) => b.goals - a.goals);
}

function generateCupResults(vikingCupRound) {
    const cupResults = [];
    
    if (vikingCupRound <= 4) {
        const otherMatches = cupData.otherResults[vikingCupRound] || [];
        otherMatches.forEach(match => {
            if (match.home !== 'Viking' && match.away !== 'Viking' && 
                match.home !== 'Viking FK' && match.away !== 'Viking FK') {
                cupResults.push({
                    team1: match.home,
                    team1Goals: match.result[0],
                    team2Goals: match.result[1],
                    team2: match.away
                });
            }
        });
    } else {
        const otherMatches = cupData.cupResults[vikingCupRound] || [];
        otherMatches.forEach(match => {
            if (match.team1 !== 'Viking' && match.team2 !== 'Viking' && 
                match.team1 !== 'Viking FK' && match.team2 !== 'Viking FK') {
                cupResults.push({
                    team1: match.team1,
                    team1Goals: match.team1Goals,
                    team2Goals: match.team2Goals,
                    team2: match.team2
                });
            }
        });
    }
    
    return cupResults;
}

function continueToNextRound() {
    soundSystem.stopAnthem();
    nextMatch();
}

function nextMatch() {
    const roundSummary = document.getElementById('roundSummary');
    if (roundSummary) roundSummary.style.display = 'none';
    
    gameState.currentMatchIndex++;
    
    if (gameState.currentMatchIndex >= vikingSchedule.length) {
        showSeasonEndSummary();
        return;
    }
    
    const nextMatchData = vikingSchedule[gameState.currentMatchIndex];
    if (nextMatchData.type === 'serie') {
        gameState.currentRound = nextMatchData.round;
    }
    
    // FULL RESET
    gameState.currentHalf = 1;
    gameState.matchTime = 0;
    gameState.matchStartTime = null;
    gameState.halfTimeBreak = false;
    gameState.gameActive = true;
    
    gameState.vikingScore = 0;
    gameState.opponentScore = 0;
    
    // Reset spillerposisjoner
    const fieldWidth = gameField ? gameField.offsetWidth : window.innerWidth;
    gameState.vikingX = fieldWidth / 2 - 40;
    gameState.opponentX = fieldWidth / 2 - 40;
    
    const viking = document.getElementById('viking');
    const opponent = document.getElementById('opponent');
    if (viking) {
        viking.style.transform = 'translateX(-50%)';
    }
    if (opponent) {
        opponent.style.transform = 'translateX(-50%)';
    }
    
    resetBallCompletely();
    
    const homeScore = document.getElementById('homeScore');
    const awayScore = document.getElementById('awayScore');
    if (homeScore) homeScore.textContent = '0';
    if (awayScore) awayScore.textContent = '0';
    
    updateUI();
    updateOpponentJersey();
    
    const clockElement = document.getElementById('matchClock');
    if (clockElement) {
        clockElement.textContent = '0\'';
    }
    
    let countdownText = "KAMPSTART";
    if (nextMatchData) {
        if (nextMatchData.type === 'cup') {
            countdownText = `CUP ${cupData.roundNames[nextMatchData.round] || 'KAMP'}`;
        } else {
            countdownText = `RUNDE ${nextMatchData.round}`;
        }
    }
    
    showCountdown(() => {
        kickOff('viking');
        gameState.gameActive = true;
    }, countdownText);
}

function showSeasonEndSummary() {
    const finalPosition = [...[vikingTeam, ...teams]].sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        const aGoalDiff = a.goalsFor - a.goalsAgainst;
        const bGoalDiff = b.goalsFor - b.goalsAgainst;
        if (bGoalDiff !== aGoalDiff) return bGoalDiff - aGoalDiff;
        return b.goalsFor - a.goalsFor;
    }).findIndex(team => team.name === 'Viking FK') + 1;

    let cupResult = '';
    if (gameState.cupEliminated) {
        cupResult = 'Ude av cupen:(';
    } else {
        cupResult = 'üèÜ CUP-MESTER 2025 - EUROPA LEAGUE TE STAVANGER!';
    }

    const messageText = document.getElementById('messageText');
    const gameMessage = document.getElementById('gameMessage');
    
    messageText.innerHTML = `
        <h2 style="color: #FFD700; margin-bottom: 20px;">üéâ SESONGEN FERDIG! üéâ</h2>
        <div style="color: #00FF00; font-size: 18px; margin: 15px 0;">
            <strong>ELITESERIEN:</strong> ${finalPosition}. plass
        </div>
        <div style="color: #FF6B6B; font-size: 16px; margin: 15px 0;">
            <strong>CUP:</strong> ${cupResult}
        </div>
        <div style="color: #FFFFFF; margin: 20px 0;">
            Kamper spilt: ${vikingTeam.played}<br>
            M√•l scoret: ${vikingTeam.goalsFor}<br>
            Poeng: ${vikingTeam.points}
        </div>
    `;
    gameMessage.style.display = 'block';
}

// ===== GLOBALE FUNKSJONER =====
window.showSummaryPage = showSummaryPage;
window.continueToNextRound = continueToNextRound;

window.startSecondHalf = function() {
    const halfTimeScreen = document.getElementById('halfTimeScreen');
    if (halfTimeScreen && halfTimeScreen.parentNode) {
        halfTimeScreen.parentNode.removeChild(halfTimeScreen);
    }
    
    resetBallCompletely();
    
    gameState.currentHalf = 2;
    gameState.matchTime = 0;
    gameState.matchStartTime = Date.now();
    gameState.halfTimeBreak = false;
    gameState.gameActive = true;
    
    // Reset spillere til sentrum (ikke bytt sider p√• mobil)
    const viking = document.getElementById('viking');
    const opponent = document.getElementById('opponent');
    const fieldWidth = gameField ? gameField.offsetWidth : window.innerWidth;
    
    gameState.vikingX = fieldWidth / 2 - 40;
    gameState.opponentX = fieldWidth / 2 - 40;
    
    if (viking) {
        viking.style.transform = 'translateX(-50%)';
    }
    if (opponent) {
        opponent.style.transform = 'translateX(-50%)';
    }
    
    updateUI();
    updateOpponentJersey();
    
    const clockElement = document.getElementById('matchClock');
    if (clockElement) {
        clockElement.textContent = '0\'';
    }
    
    showCountdown(() => {
        kickOff(gameState.vikingScore > gameState.opponentScore ? 'opponent' : 'viking');
        gameState.gameActive = true;
    }, "2. OMGANG");
};

window.restartSeason = function() {
    gameState.currentRound = 1;
    gameState.currentMatchIndex = 0;
    gameState.cupEliminated = false;
    gameState.topScorers = [];
    
    vikingTeam.played = 0;
    vikingTeam.won = 0;
    vikingTeam.lost = 0;
    vikingTeam.points = 0;
    vikingTeam.goalsFor = 0;
    vikingTeam.goalsAgainst = 0;

    teams.forEach(team => {
        team.played = 0;
        team.won = 0;
        team.lost = 0;
        team.draws = 0; 
        team.points = 0;
        team.goalsFor = 0;
        team.goalsAgainst = 0;
    });

    const roundSummary = document.getElementById('roundSummary');
    const gameMessage = document.getElementById('gameMessage');
    
    if (roundSummary) {
        roundSummary.style.display = 'none';
    }
    
    // SKJUL GAMEMESSAGE N√ÖR NY SESONG STARTER
    if (gameMessage) {
        gameMessage.style.display = 'none';
    }
    
    initializeGame();
};

function setupFullScreenTouch() {
    document.body.style.touchAction = 'none';
    document.body.style.userSelect = 'none';
    
    document.addEventListener('touchstart', handleFullScreenTouch, {passive: false});
    document.addEventListener('touchmove', handleFullScreenTouch, {passive: false});
}

function handleFullScreenTouch(e) {
    const target = e.target;
    if (target.tagName === 'BUTTON' || 
        target.tagName === 'INPUT' || 
        target.tagName === 'A' ||
        target.closest('button') ||
        target.closest('.button') ||
        target.id === 'startGameBtn') {
        return;
    }
    
    const touch = e.touches[0];
    const screenHeight = window.innerHeight;
    
    if (touch.clientY > screenHeight - 100) {
        e.preventDefault();
        
        const relativeX = touch.clientX / window.innerWidth;
        
        const gameField = document.getElementById('gameField');
        const fieldWidth = gameField ? gameField.offsetWidth : window.innerWidth;
        const playerWidth = 80;
        const maxX = fieldWidth - playerWidth;
        
        const targetX = relativeX * fieldWidth;
        const smoothing = 0.3;
        gameState.vikingX = gameState.vikingX + (targetX - gameState.vikingX) * smoothing;
        
        gameState.vikingX = Math.max(0, Math.min(maxX, gameState.vikingX));
    }
}

// ===== START SEKVENS =====
document.addEventListener('DOMContentLoaded', function() {
    soundSystem.init();
    startIntroSequence();
    
    setTimeout(() => {
        const startBtn = document.getElementById('startGameBtn');
        if (startBtn) {
            startBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                startMainGame();
            }, {passive: false});
            
            startBtn.addEventListener('click', function(e) {
                e.preventDefault();
                startMainGame();
            });
        }
    }, 1000);
});

document.addEventListener('click', function startIntroOnClick() {
    if (!introStarted) {
        startIntroSequence();
    }
    soundSystem.startIntro();
    document.removeEventListener('click', startIntroOnClick);
}, { once: true });
    </script>
</body>
</html>



